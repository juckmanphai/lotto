<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>บัญชีขาย</title>

    <!-- [PWA] Link to Manifest & Theme Color -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4a90e2">
    
    <style>
        /* === CSS MERGED FROM FILE 10.html AND ADAPTED FOR POS SYSTEM === */
        :root {
            --primary-color: #4a90e2;
            --danger-color: #d0021b;
            --success-color: #28a745;
            --warning-color: #f5a623;
            --border-color: #BFBFBF; /* Darkened border for better visibility */
        }

        *, *::before, *::after { box-sizing: border-box; }
        
        body { 
            font-family: 'Sarabun', 'Arial', sans-serif; 
            background-color: #f4f7fb; 
            margin: 0; 
            padding: 0; 
            -webkit-text-size-adjust: 100%; 
            -ms-text-size-adjust: 100%; 
            text-size-adjust: 100%; 
        }

        .main-wrapper {
            max-width: 1200px; 
            margin: 15px auto; 
            background-color: #FAFAD2; 
            border: 2px solid #ED01ED; 
            padding: 10px; 
            border-radius: 10px; 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); 
            width: 95%;
        }

        #login-screen { 
            padding: 40px; 
            text-align: center;
        }
        #login-screen h1 { 
            margin-top: 0; 
            color: #333;
            font-size: clamp(1.5rem, 1.5rem + 2vw, 2.8rem);
        }
        #main-app { 
            display: none; 
        }

        .top-bar {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 20px;
            border-radius: 8px 8px 0 0;
            margin-bottom: 10px;
            text-align: center;
        }
        .top-bar h1 {
            margin: 0 0 10px 0;
            font-size: clamp(1.2rem, 1.2rem + 1.5vw, 2.2rem);
        }
        #user-info-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            font-size: 0.9em;
        }
        #logout-btn {
            background-color: var(--danger-color);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #logout-btn:hover {
            background-color: #b90218;
        }
        
        .section-header { 
            color: white; 
            padding: 12px 15px; 
            border-radius: 20px; 
            margin-bottom: 10px; 
            cursor: pointer; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border: 3px solid #E97132;
            transition: background-color 0.3s;
        }
        .section-header:hover { background-color: #B5E6A2; color: #333; }
        .section-header .arrow { transition: transform 0.3s; }
        .section-header.active .arrow { transform: rotate(90deg); }
        .section-header > span:first-child { flex: 1; text-align: center; font-size: 1.1em; }
        
        /* --- Colors for each section header --- */
        .header-pos { background-color: #00B0F0; }
        .header-products { background-color: #00B050; }
        .header-stock { background-color: #28a745; }
        .header-stock-out { background-color: var(--warning-color); } /* NEW Color for Stock Out */
        .header-history { background-color: #ff9800; }
        .header-reports { background-color: #ED01ED; }
        .header-summary { background-color: #673ab7; }
        .header-stores { background-color: #ff5722; } /* New Color for Stores */
        .header-users { background-color: #0070C0; }
        .header-data { background-color: #607d8b; }
        
        .section-content { 
            display: none; 
            padding: 20px; 
            border: 1px solid #ddd; 
            border-radius: 20px; 
            background-color: #f9f9f9; 
            margin-bottom: 15px; 
        }
        .section-content.active { display: block; }
        
        /* --- Styles for collapsible bars inside a section --- */
        .collapsible-bar {
            background-color: #78909c;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 15px;
            margin-bottom: 0;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s;
        }
        .collapsible-bar:hover {
             background-color: #607d8b;
        }
        .collapsible-bar .arrow {
            transition: transform 0.3s;
        }
        .collapsible-bar.active .arrow {
            transform: rotate(90deg);
        }
        .collapsible-content {
            display: none;
            padding: 15px;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 8px 8px;
            background-color: #fafafa;
            margin-bottom: 10px;
        }
        .collapsible-content.active {
            display: block;
        }


        h2 { 
            text-align: center; 
            color: #333; 
            margin-top: 0; 
            margin-bottom: 25px;
            font-size: clamp(1.2rem, 1rem + 1.5vw, 1.8rem);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
        }
        
        /* --- TABLE STYLES (Desktop) --- */
        .table-container {
            overflow-x: auto;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            margin-top: 20px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }
        
        th, td {
            border: 1px solid var(--border-color);
            padding: 6px 8px; 
            text-align: center; 
            vertical-align: middle;
            white-space: nowrap; 
            font-size: clamp(0.8rem, 1.5vw, 0.9rem); 
        }
        
        /* Wrapping for specific long-text columns */
        #page-pos #cart-table td:first-child,
        #page-products #product-table td:first-child,
        #page-sales-history #sales-history-table td:nth-child(3),
        #seller-sales-history-table td:nth-child(3), /* Added for new seller table */
        #page-stock-out #stock-out-history-table td:nth-child(5), /* NEW: Stock Out Reason */
        #page-stores #store-table td:first-child, /* New */
        #page-users #user-table td:first-child,
        #page-users #user-table td:nth-child(3),
        #page-users #user-table td:nth-child(4),
        #page-users #user-table td:nth-child(5) { /* New */
             white-space: normal;
             word-break: break-word;
             min-width: 120px;
        }

        /* min-width for number columns (REMOVED text-align: right) */
        #page-pos #cart-table td:nth-child(2), /* Price */
        #page-pos #cart-table td:nth-child(3), /* Qty */
        #page-pos #cart-table td:nth-child(4), /* Total */
        #page-products #product-table td:nth-child(2), /* Cost */
        #page-products #product-table td:nth-child(3), /* Price */
        #page-products #product-table td:nth-child(4), /* Stock */
        #page-sales-history #sales-history-table td:nth-child(4), /* Total Sale */
        #page-sales-history #sales-history-table td:nth-child(5), /* Profit */
        #seller-sales-history-table td:nth-child(4), /* Added for new seller table */
        #page-stock-in #stock-in-history-table td:nth-child(4), /* Qty */
        #page-stock-in #stock-in-history-table td:nth-child(5), /* Cost */
        #page-stock-in #stock-in-history-table td:nth-child(6), /* Total */
        #page-stock-out #stock-out-history-table td:nth-child(4) { /* Qty */
            min-width: 70px;
        }
        .action-buttons {
             min-width: 100px;
             white-space: nowrap;
        }
        
        th {
            background-color: #f2f2f2;
        }
        
        .action-buttons button { margin-right: 5px; padding: 5px 10px; font-size: 0.9em; margin-top: 5px;}

        form {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 15px;
            align-items: center;
            max-width: 600px;
            margin: 0 auto 20px auto;
        }
        form label { text-align: right; font-weight: bold; }
        input, select {
            padding: 10px;
            border-radius: 20px;
            border: 1px solid #ddd;
            font-family: inherit;
            font-size: 1em;
            width: 100%;
            box-sizing: border-box;
            text-align: center;
        }
        input:disabled, select:disabled { background-color: #eee; cursor: not-allowed; }
        button { 
            cursor: pointer; 
            color: white; 
            border: none;
            font-size: 1em;
            padding: 12px;
            border-radius: 50px;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        button:hover { transform: translateY(-2px); }

        .form-actions { grid-column: 1 / -1; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .form-actions button { flex-grow: 1; max-width: 250px; }
        
        button.success, #process-sale-btn { background-color: var(--success-color); }
        button.success:hover, #process-sale-btn:hover { background-color: #218838; }
        button.danger { background-color: var(--danger-color); }
        button.danger:hover { background-color: #b90218; }
        button#toggle-special-price-btn { background-color: var(--warning-color); }
        button#toggle-special-price-btn:hover { background-color: #d8901e; }
        
        #page-pos .pos-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        #cart-summary { background-color: #eef5ff; padding: 15px; border-radius: 8px; }
        #cart-total { font-size: clamp(1.5rem, 1.5rem + 2.5vw, 3rem); font-weight: bold; text-align: right; margin-top: 15px; color: #0070C0; }
        #process-sale-btn { font-size: clamp(1.1rem, 1rem + 0.5vw, 1.4rem); width: 100%; }
        #payment-method-container { margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd; }
        
        .payment-options-wrapper {
            display: flex;
            gap: 20px;
            align-items: center;
            margin: 10px 0;
            flex-wrap: wrap; /* Added for better mobile view */
        }
        
        /* --- Change Radio Button Color --- */
        #payment-method-container input[type="radio"] {
            accent-color: var(--danger-color);
        }

        #credit-fields-container, #transfer-fields-container { margin-top: 10px; display: none; }

        #report-filter-form {
            display: grid;
            grid-template-columns: auto auto auto 1fr; /* Default for desktop */
            gap: 15px;
            max-width: none;
            align-items: end;
        }
        #report-filter-form label {
            text-align: left;
            font-weight: normal;
        }
        #report-generate-btn {
            background-color: #009688;
            justify-self: start;
            max-width: 150px;
        }
        
        /* NEW: Styles for Sales History Export */
        #sales-history-export-form {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
            justify-content: center;
            background-color: #eef5ff;
            padding: 15px;
            border-radius: 8px;
            margin: -10px auto 25px auto;
            border: 1px solid var(--primary-color);
        }
        #sales-history-export-form label {
            font-weight: bold;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        #sales-history-export-form input[type="date"] {
            padding: 8px;
            border-radius: 5px;
            min-width: 150px;
        }
        #export-sales-history-csv-btn {
            padding: 10px 20px;
            font-size: 1em;
            background-color: #008CBA; /* A different blue */
        }


        .data-management-section { border: 1px solid var(--border-color); padding: 20px; margin-top: 20px; border-radius: 8px; background: #fafafa; text-align: center; }
        .data-management-section h3 { margin-top: 0; border-bottom: 1px solid #BFBFBF; padding-bottom: 10px; }
        .data-management-section button { margin: 5px; padding: 10px 15px; }

        .summary-section { border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px 20px; margin-bottom: 20px; background-color: #fdfdfd; }
        .summary-form-inline { display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; }
        
        #toast-notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 12px 24px; color: white; background-color: var(--success-color); border-radius: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 1001; opacity: 0; visibility: hidden; transition: opacity 0.5s, visibility 0.5s, transform 0.5s; font-size: 1.1em; }
        #toast-notification.show { opacity: 1; visibility: visible; }

        /* MODAL STYLES */
        .modal-overlay { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; padding: 5px; overflow-y: auto; }
        .modal-content-container { background-color: transparent; padding: 0; border: none; box-shadow: none; display: flex; flex-direction: column; align-items: center; margin: auto 0; width: 100%; max-width: 950px; }
        #modalBodyContent { background-color: #FAFAD2; border: 3px solid #4CAF50; border-radius: 10px; padding: 15px; width: 100%; box-shadow: 0 4px 12px rgba(0,0,0,0.25); max-height: 85vh; overflow-y: auto; }
        #modalBodyContent, #modalBodyContent * { color: blue !important; }
        
        #modalBodyContent h2 {
            margin-top: 0;
            margin-bottom: 8px; 
            padding-bottom: 5px;
            font-size: 1.2rem;
        }
        #modalBodyContent p {
            margin-top: 4px; 
            margin-bottom: 4px; 
            line-height: 1.3;
        }
        #modalBodyContent table {
            margin-top: 10px; 
        }
        #modalBodyContent hr {
            margin: 15px 0; 
        }
        
        .modal-close-btn { background-color: #E97132; color: white; padding: 12px 30px; border: none; cursor: pointer; border-radius: 20px; font-size: 16px; margin-top: 10px; transition: background-color 0.3s; }
        .modal-close-btn:hover { background-color: #e64a19; }
        .format-modal-content { background-color: #fff; padding: 20px 30px; border-radius: 15px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 400px; }
        .format-modal-buttons { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
        .format-modal-buttons button { padding: 15px; font-size: 16px; border-radius: 10px; }
        .format-modal-buttons .btn-csv { background-color: #2E7D32; }
        .format-modal-buttons .btn-display { background-color: #007bff; }
        .format-modal-buttons .btn-cancel { background-color: #6c757d; }
        
        /* === NEW: RESET MODAL === */
        #reset-modal-content {
            background-color: #fff;
            padding: 20px 30px;
            border-radius: 15px;
            text-align: left;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 500px;
        }
        #reset-modal-content h3 {
            text-align: center;
            color: var(--danger-color);
            margin-top: 0;
        }
        #reset-options-container {
            margin-top: 20px;
            margin-bottom: 20px;
        }
        #reset-options-container label {
            display: block;
            margin-bottom: 12px;
            font-size: 1.1em;
            cursor: pointer;
        }
        #reset-options-container input {
            width: auto;
            margin-right: 10px;
        }
        #reset-modal-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        /* === START: USER REQUEST - Style for single-product seller view in POS === */
        #page-pos #pos-product.single-product-seller:disabled {
            background-color: var(--success-color); /* ใช้ตัวแปรสีเขียวที่มีอยู่แล้ว */
            color: white;
            font-weight: bold; /* เพิ่มความหนาให้ตัวอักษร อ่านง่ายขึ้น */
            opacity: 1; /* ทำให้ไม่จาง */
            cursor: default; /* ยังคงเป็น cursor ที่บ่งบอกว่าคลิกไม่ได้ */
            border: 2px solid #1e7e34; /* เพิ่มเส้นขอบสีเข้มเล็กน้อย */
        }
        /* === END: USER REQUEST === */
        
        /* === START: NEW - Style for backdating inputs === */
        #pos-date.backdating-active,
        #pos-time.backdating-active {
            background-color: #fffbe6; /* สีเหลืองอ่อน */
            border-color: #f5a623; /* สีส้ม */
            font-weight: bold;
        }
        /* === END: NEW === */


        /* RESPONSIVE STYLES */
        @media (max-width: 768px) {
            .main-wrapper {
                width: 100%;
                margin: 0;
                border-radius: 0;
                border: none;
                min-height: 100vh;
            }
            form {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            form label {
                text-align: left;
                margin-bottom: -10px;
            }

            /* --- NEW: Override for POS form to be two-column on mobile --- */
            #page-pos #add-to-cart-form {
                grid-template-columns: auto 1fr;
                gap: 10px 8px; /* row-gap column-gap */
            }
            #page-pos #add-to-cart-form label {
                text-align: right;
                margin-bottom: 0;
                white-space: nowrap;
            }
            /* --- END NEW --- */
            
            .form-actions {
                flex-direction: column;
                align-items: stretch;
            }
            .form-actions button {
                width: 100%;
                max-width: none;
            }
            #page-pos .pos-layout {
                grid-template-columns: 1fr;
            }

            /* === START: MOBILE TABLE OVERRIDES (UNIFIED HORIZONTAL LAYOUT) === */
            table {
                table-layout: auto !important; 
            }
            
            table thead, table tbody, table tr {
                display: revert; 
            }

            table th, table td {
                display: table-cell;
                border: 1px solid var(--border-color);
                padding: 4px 5px; 
                font-size: clamp(9px, 2.2vw, 12px); 
                line-height: 1.2;
                vertical-align: middle;
            }

            table td::before {
                display: none;
            }
            
            /* === START: *** REFINED & MORE FORCEFUL *** RULES FOR POS CART TABLE ON MOBILE === */
            #page-pos #cart-table {
                table-layout: fixed;
                width: 100%;
            }
            #page-pos #cart-table th:nth-child(1),
            #page-pos #cart-table td:nth-child(1) { width: 38%; } /* Product Name */
            
            #page-pos #cart-table th:nth-child(2),
            #page-pos #cart-table td:nth-child(2) { width: 18%; } /* Price */
            
            #page-pos #cart-table th:nth-child(3),
            #page-pos #cart-table td:nth-child(3) { width: 12%; } /* Qty */
            
            #page-pos #cart-table th:nth-child(4),
            #page-pos #cart-table td:nth-child(4) { width: 18%; } /* Total */
            
            #page-pos #cart-table th:nth-child(5),
            #page-pos #cart-table td:nth-child(5) { width: 14%; } /* Delete */

            #page-pos #cart-table td:first-child { /* Product Name */
                white-space: normal !important;      /* FORCE wrapping for long names */
                word-break: break-word !important;   /* FORCE word breaking */
                min-width: 0; /* Override any desktop min-width */
            }
            #page-pos #cart-table td:nth-child(2), /* Price */
            #page-pos #cart-table td:nth-child(3), /* Qty */
            #page-pos #cart-table td:nth-child(4) { /* Total */
                 white-space: nowrap;
            }
            #page-pos #cart-table .action-buttons {
                min-width: auto;
            }
            #page-pos #cart-table .action-buttons button { /* Smaller delete button */
                padding: 4px 6px;
                font-size: 0.8em;
                margin: 0;
            }
             /* === END: REFINED RULES FOR POS CART TABLE === */

            /* === START: USER REQUEST - Green Cart Table Customization (Data Rows Only) === */
            /* Target ONLY the data cells (td) inside the cart table's body */
            #page-pos #cart-table tbody td {
                background-color: var(--success-color);
                color: white;
                /* Use a lighter border that complements the green background */
                border-color: #a3d9b1;
            }

            /* Double the vertical padding for height increase (Desktop) */
            /* This is outside the media query but is applied first */
            #page-pos #cart-table tbody td {
                padding-top: 12px;
                padding-bottom: 12px;
            }

            /* Ensure header (th) remains with its default style for contrast */
            #page-pos #cart-table th {
                background-color: #f2f2f2; /* Default from general table style */
                color: #333; /* Default text color */
                padding-top: 6px;  /* Keep original padding */
                padding-bottom: 6px;
            }

            @media (max-width: 768px) {
                /* Double the vertical padding for height increase (Mobile) */
                #page-pos #cart-table tbody td {
                    padding-top: 16px;
                    padding-bottom: 16px;
		    font-size: 16px;
                }
                /* Keep original mobile padding for header */
                 #page-pos #cart-table th {
                    padding-top: 4px;
                    padding-bottom: 4px;
                }
            }
            /* === END: USER REQUEST === */

            /* === POS Page Mobile Compacting Rules === */
            #page-pos h2, #page-pos h3 {
                margin-bottom: 15px;
                padding-bottom: 8px;
                font-size: 1.1rem;
            }
            #page-pos #add-to-cart-form {
                /* gap is now set in the override rule above */
                margin-bottom: 15px;
            }
            #page-pos #add-to-cart-form input,
            #page-pos #add-to-cart-form select {
                padding: 8px 10px;
                font-size: 0.9em;
            }
            #page-pos #add-to-cart-form .form-actions button {
                padding: 10px;
                font-size: 0.95em;
            }
            #page-pos #special-price-container {
                 grid-template-columns: 100px 1fr;
                 gap: 8px;
            }

            /* --- Cart Summary Compacting Rules --- */
            #page-pos #cart-summary {
                padding: 10px;
            }
            #page-pos #cart-summary h4 {
                font-size: 1rem;
                margin-top: 0;
                margin-bottom: 5px;
            }
            #page-pos #payment-method-container {
                margin-top: 10px;
                padding-top: 10px;
                border-top: none; 
            }
            #page-pos .payment-options-wrapper {
                margin: 5px 0 10px 0;
                gap: 15px;
            }
             #page-pos #credit-fields-container,
             #page-pos #transfer-fields-container {
                margin-top: 5px;
            }
            #page-pos #credit-fields-container > div,
            #page-pos #transfer-fields-container > div {
                margin-top: 5px;
            }
            
            #page-pos .cart-action-row {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-top: 15px;
                padding-top: 10px;
                border-top: none;
            }
            #page-pos .cart-total-label {
                font-size: 1rem;
                font-weight: bold;
                white-space: nowrap;
            }
            #page-pos #cart-total {
                font-size: 1.6rem; 
                margin: 0;
                flex-grow: 1;
                text-align: right;
            }
            #page-pos #process-sale-btn {
                padding: 8px 10px; 
                font-size: 1.0em; 
                margin: 0;
                flex-shrink: 0;
                width: auto; 
            }
            
            /* MODAL (POPUP) RESPONSIVE STYLES */
            
            /* --- General Compactness --- */
            #modalBodyContent { padding: 10px; }
            #modalBodyContent h2 {
                font-size: 1.0rem; 
                padding-bottom: 4px;
                margin-bottom: 6px;
            }
            #modalBodyContent table th {
                font-size: clamp(8px, 2.2vw, 10px); 
                padding: 2px 3px;
            }
            #modalBodyContent table td {
                padding: 2px 3px;
                vertical-align: middle;
            }
            #modalBodyContent table td::before { display: none; }
            #modalBodyContent table thead,
            #modalBodyContent table tr,
            #modalBodyContent table th, 
            #modalBodyContent table td {
                display: table-cell; /* Force table display */
            }
            #modalBodyContent table thead { display: table-header-group; }
            #modalBodyContent table tr { display: table-row; }


            /* --- Universal Table Layout Rules for ALL Summary Popups --- */
            #modalBodyContent .credit-details-table,
            #modalBodyContent .transfer-details-table,
            #modalBodyContent .product-summary-table {
                table-layout: fixed;
                width: 100%;
            }
            /* Universal TD rule: allow wrapping by default and handle long words. */
            #modalBodyContent .credit-details-table td,
            #modalBodyContent .transfer-details-table td,
            #modalBodyContent .product-summary-table td {
                word-break: break-word;
                white-space: normal; /* Default to wrapping */
                overflow: hidden;
                text-overflow: ellipsis;
            }

            /* --- PRODUCT SUMMARY Table (For BOTH Admin & Seller) --- */
            #modalBodyContent .product-summary-table th:nth-of-type(1),
            #modalBodyContent .product-summary-table td:nth-of-type(1) { width: 30%; } /* Name (wraps) */
            
            #modalBodyContent .product-summary-table th:nth-of-type(2),
            #modalBodyContent .product-summary-table td:nth-of-type(2),
            #modalBodyContent .product-summary-table th:nth-of-type(3),
            #modalBodyContent .product-summary-table td:nth-of-type(3),
            #modalBodyContent .product-summary-table th:nth-of-type(4),
            #modalBodyContent .product-summary-table td:nth-of-type(4),
            #modalBodyContent .product-summary-table th:nth-of-type(5),
            #modalBodyContent .product-summary-table td:nth-of-type(5) { 
                width: 10%; 
                white-space: nowrap; /* No wrap for quantities */
            }
            
            #modalBodyContent .product-summary-table th:nth-of-type(6),
            #modalBodyContent .product-summary-table td:nth-of-type(6) { width: 15%; white-space: nowrap; } /* Value (no wrap) */
            
            #modalBodyContent .product-summary-table th:nth-of-type(7),
            #modalBodyContent .product-summary-table td:nth-of-type(7) { width: 15%; white-space: nowrap; } /* Stock (no wrap) */
            
            /* --- 6-COLUMN CREDIT DETAILS Table (For Seller Credit Summary & Admin Credit Summary) --- */
            #modalBodyContent .credit-details-table:not(.credit-details-sub-table) th:nth-of-type(1),
            #modalBodyContent .credit-details-table:not(.credit-details-sub-table) td:nth-of-type(1) { width: 13%; white-space: nowrap; } /* Date */
            
            #modalBodyContent .credit-details-table:not(.credit-details-sub-table) th:nth-of-type(2),
            #modalBodyContent .credit-details-table:not(.credit-details-sub-table) td:nth-of-type(2) { width: 20%; } /* Buyer (wraps) */
            
            #modalBodyContent .credit-details-table:not(.credit-details-sub-table) th:nth-of-type(3),
            #modalBodyContent .credit-details-table:not(.credit-details-sub-table) td:nth-of-type(3) { width: 17%; } /* Seller (wraps) */
            
            #modalBodyContent .credit-details-table:not(.credit-details-sub-table) th:nth-of-type(4),
            #modalBodyContent .credit-details-table:not(.credit-details-sub-table) td:nth-of-type(4) { width: 22%; } /* Items (wraps) */
            
            #modalBodyContent .credit-details-table:not(.credit-details-sub-table) th:nth-of-type(5),
            #modalBodyContent .credit-details-table:not(.credit-details-sub-table) td:nth-of-type(5) { width: 15%; white-space: nowrap; } /* Amount */
            
            #modalBodyContent .credit-details-table:not(.credit-details-sub-table) th:nth-of-type(6),
            #modalBodyContent .credit-details-table:not(.credit-details-sub-table) td:nth-of-type(6) { width: 13%; white-space: nowrap; } /* Due Date */
            
            /* --- 5-COLUMN CREDIT SUB-TABLE (in Admin POS Summary) --- */
            #modalBodyContent .credit-details-sub-table th:nth-of-type(1),
            #modalBodyContent .credit-details-sub-table td:nth-of-type(1) { width: 15%; white-space: nowrap; } /* Date */
            
            #modalBodyContent .credit-details-sub-table th:nth-of-type(2),
            #modalBodyContent .credit-details-sub-table td:nth-of-type(2) { width: 20%; } /* Buyer (wraps) */
            
            #modalBodyContent .credit-details-sub-table th:nth-of-type(3),
            #modalBodyContent .credit-details-sub-table td:nth-of-type(3) { width: 35%; } /* Items (wraps) */
            
            #modalBodyContent .credit-details-sub-table th:nth-of-type(4),
            #modalBodyContent .credit-details-sub-table td:nth-of-type(4) { width: 15%; white-space: nowrap; } /* Amount */
            
            #modalBodyContent .credit-details-sub-table th:nth-of-type(5),
            #modalBodyContent .credit-details-sub-table td:nth-of-type(5) { width: 15%; white-space: nowrap; } /* Due Date */
            
            /* --- NEW: 4-COLUMN TRANSFER SUB-TABLE (in Admin POS Summary) --- */
            #modalBodyContent .transfer-details-sub-table th:nth-of-type(1),
            #modalBodyContent .transfer-details-sub-table td:nth-of-type(1) { width: 15%; white-space: nowrap; } /* Date */
            
            #modalBodyContent .transfer-details-sub-table th:nth-of-type(2),
            #modalBodyContent .transfer-details-sub-table td:nth-of-type(2) { width: 25%; } /* Transferor (wraps) */
            
            #modalBodyContent .transfer-details-sub-table th:nth-of-type(3),
            #modalBodyContent .transfer-details-sub-table td:nth-of-type(3) { width: 40%; } /* Items (wraps) */
            
            #modalBodyContent .transfer-details-sub-table th:nth-of-type(4),
            #modalBodyContent .transfer-details-sub-table td:nth-of-type(4) { width: 20%; white-space: nowrap; } /* Amount */


            /* --- TRANSFER DETAILS Table (For BOTH Admin & Seller) --- */
            #modalBodyContent .transfer-details-table th:nth-of-type(1),
            #modalBodyContent .transfer-details-table td:nth-of-type(1) { width: 15%; white-space: nowrap; } /* Date */
            
            #modalBodyContent .transfer-details-table th:nth-of-type(2),
            #modalBodyContent .transfer-details-table td:nth-of-type(2) { width: 25%; } /* Transferor (wraps) */
            
            #modalBodyContent .transfer-details-table th:nth-of-type(3),
            #modalBodyContent .transfer-details-table td:nth-of-type(3) { width: 20%; } /* Seller (wraps) */
            
            #modalBodyContent .transfer-details-table th:nth-of-type(4),
            #modalBodyContent .transfer-details-table td:nth-of-type(4) { width: 25%; } /* Items (wraps) */
            
            #modalBodyContent .transfer-details-table th:nth-of-type(5),
            #modalBodyContent .transfer-details-table td:nth-of-type(5) { width: 15%; white-space: nowrap; } /* Amount */
            
            #report-filter-form {
                grid-template-columns: 1fr; /* Stack into a single column on mobile */
                gap: 10px;
            }

            #report-generate-btn {
                width: 100%;
                max-width: none; /* Override desktop max-width */
                justify-self: stretch; /* Make it fill the grid cell */
            }

            /* === START: SELLER VIEW MOBILE ENHANCEMENTS (USER REQUEST) === */
            
            /* เพิ่มระยะห่างและทำให้เนื้อหาดูโปร่งขึ้น */
            .collapsible-content.seller-only {
                padding: 20px 15px;
            }

            /* --- ปรับปรุงส่วนสรุปข้อมูลของผู้ขาย --- */
            #seller-summary-content div:first-of-type {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }
             #seller-summary-content button {
                padding: 14px;
                font-size: 1.1em;
                font-weight: bold;
                width: 100%;
            }
            #seller-summary-content .summary-form-inline {
                flex-direction: column;
                align-items: stretch;
            }
             #seller-summary-content .summary-form-inline label {
                font-size: 1.1em;
                text-align: center;
                margin-bottom: 5px;
            }
            
            /* --- ปรับปรุงตารางรายการขายของผู้ขาย --- */
            #seller-sales-history-table th {
                background-color: var(--primary-color); /* ใช้สีหลักของเว็บ */
                color: white;
                font-size: 15px;
                font-weight: bold;
                padding: 10px 8px;
            }
            #seller-sales-history-table td {
                font-size: 16px; /* ขนาดตัวอักษรที่อ่านง่ายบนมือถือ */
                padding: 12px 8px; /* เพิ่มความสูงของแถว */
            }

            /* คอลัมน์รายการสินค้า (ทำให้เด่นและอ่านง่าย) */
            #seller-sales-history-table td:nth-child(3) {
                text-align: left;
                line-height: 1.4;
                font-weight: 500; /* หนาขึ้นเล็กน้อย */
            }
            
            /* คอลัมน์ยอดขาย (ทำให้เด่น) */
            #seller-sales-history-table td:nth-child(4) {
                font-weight: bold;
                color: var(--primary-color);
            }

            /* --- ปรับปรุงส่วน Backup ข้อมูลของผู้ขาย --- */
            #seller-backup-content p {
                font-size: 1em;
                line-height: 1.5;
                margin-bottom: 20px;
            }
             #seller-backup-content div {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            #seller-backup-content button {
                width: 100%;
                padding: 14px;
                font-size: 1.1em;
                font-weight: bold;
            }

            /* === END: SELLER VIEW MOBILE ENHANCEMENTS === */

        }
    </style>
</head>
<body>
    <div class="main-wrapper">
        <div id="login-screen">
            <h1>บัญชีขาย</h1>
            <p>กรุณาเข้าสู่ระบบ</p>
            <form id="login-form" style="display: inline-grid; max-width: 350px;">
                <label for="username">ชื่อผู้ใช้:</label>
                <input type="text" id="username" required>
                <label for="password">รหัสผ่าน:</label>
                <input type="password" id="password" required>
                
                <!-- === START: REMEMBER ME CHECKBOX === -->
                <div style="grid-column: 1 / -1; text-align: left; margin: 5px 0 10px 0;">
                    <label style="font-weight: normal; cursor: pointer;">
                        <input type="checkbox" id="remember-me">
                        จดจำการเข้าสู่ระบบในครั้งถัดไป
                    </label>
                </div>
                <!-- === END: REMEMBER ME CHECKBOX === -->

                <div class="form-actions">
                    <button type="submit" class="success">เข้าสู่ระบบ</button>
                </div>
            </form>
            <p id="login-error" style="color: var(--danger-color);"></p>
        </div>

        <div id="main-app">
            <div class="top-bar">
                <h1 style="font-size: 16px; font-style: normal;">
  บัญชีขาย <span id="store-display-name" style="color: #FFD700; font-style: normal;"></span>
</h1>
                <div id="user-info-container">
                    <span id="user-info"></span>
                    <button id="logout-btn">ออกจากระบบ</button>
                </div>
            </div>

            <!-- Collapsible Sections -->
            <div class="section-header header-pos" onclick="App.showPage('page-pos')">
                <span>ขายสินค้า (POS)</span><span class="arrow">▶</span>
            </div>
            <div id="page-pos" class="section-content"></div>

            <div class="section-header header-products admin-only" onclick="App.showPage('page-products')">
                <span>จัดการสินค้า</span><span class="arrow">▶</span>
            </div>
            <div id="page-products" class="section-content admin-only"></div>

            <div class="section-header header-stock admin-only" onclick="App.showPage('page-stock-in')">
                <span>นำเข้าสินค้า</span><span class="arrow">▶</span>
            </div>
            <div id="page-stock-in" class="section-content admin-only"></div>

            <!-- NEW STOCK OUT SECTION -->
            <div class="section-header header-stock-out admin-only" onclick="App.showPage('page-stock-out')">
                <span>ปรับสต็อก (นำออก)</span><span class="arrow">▶</span>
            </div>
            <div id="page-stock-out" class="section-content admin-only"></div>

            <div class="section-header header-history admin-only" onclick="App.showPage('page-sales-history')">
                <span>รายการขายย้อนหลัง</span><span class="arrow">▶</span>
            </div>
            <div id="page-sales-history" class="section-content admin-only"></div>

            <div class="section-header header-reports admin-only" onclick="App.showPage('page-reports')">
                <span>รายงานกำไร/ขาดทุน</span><span class="arrow">▶</span>
            </div>
            <div id="page-reports" class="section-content admin-only"></div>

            <div class="section-header header-summary admin-only" onclick="App.showPage('page-summary')">
                <span>สรุปข้อมูล</span><span class="arrow">▶</span>
            </div>
            <div id="page-summary" class="section-content admin-only"></div>
            
            <div class="section-header header-stores admin-only" onclick="App.showPage('page-stores')">
                <span>จัดการร้านค้า</span><span class="arrow">▶</span>
            </div>
            <div id="page-stores" class="section-content admin-only"></div>

            <div class="section-header header-users admin-only" onclick="App.showPage('page-users')">
                <span>จัดการผู้ใช้</span><span class="arrow">▶</span>
            </div>
            <div id="page-users" class="section-content admin-only"></div>

            <div class="section-header header-data" onclick="App.showPage('page-data')">
                <span>จัดการข้อมูล</span><span class="arrow">▶</span>
            </div>
            <div id="page-data" class="section-content"></div>
        </div>
    </div>

    <div id="toast-notification"></div>
    <div id="summaryModal" class="modal-overlay"><div class="modal-content-container"><div id="modalBodyContent"></div><button onclick="App.closeSummaryModal()" class="modal-close-btn">ปิดหน้าต่างนี้</button></div></div>
    <div id="summaryOutputModal" class="modal-overlay"><div class="format-modal-content"><h3>เลือกรูปแบบการแสดงผลสรุป</h3><div class="format-modal-buttons"><button class="btn-display" onclick="App.handleSummaryOutput('display')">แสดงบนจอ</button><button class="btn-csv" onclick="App.handleSummaryOutput('csv')">ส่งออกเป็น CSV</button><button class="btn-cancel" onclick="App.closeSummaryOutputModal()">ยกเลิก</button></div></div></div>
    
    <!-- NEW: Reset Modal -->
    <div id="resetModal" class="modal-overlay">
        <div id="reset-modal-content">
            <h3>เลือกข้อมูลที่จะรีเซ็ต</h3>
            <p style="color: var(--danger-color); font-weight: bold;">คำเตือน: การกระทำนี้ไม่สามารถย้อนกลับได้! โปรดเลือกด้วยความระมัดระวัง</p>
            <div id="reset-options-container">
                <label><input type="checkbox" id="reset-sales-checkbox"> ลบประวัติการขายทั้งหมด (Sales)</label>
                <label><input type="checkbox" id="reset-stockins-checkbox"> ลบประวัติการนำเข้าทั้งหมด (Stock-ins)</label>
                <label><input type="checkbox" id="reset-products-checkbox"> ลบสินค้าทั้งหมด (Products)</label>
                <label style="color: var(--danger-color);"><input type="checkbox" id="reset-sellers-checkbox"> ลบผู้ขายทั้งหมด (Sellers - ยกเว้น Admin)</label>
                <label style="color: var(--danger-color);"><input type="checkbox" id="reset-stores-checkbox"> ลบร้านค้าทั้งหมด (Stores)</label>
            </div>
            <div id="reset-modal-actions">
                <button type="button" id="cancel-reset-btn" style="background-color: #6c757d;">ยกเลิก</button>
                <button type="button" id="confirm-selective-reset-btn" class="danger">ยืนยันการรีเซ็ต</button>
            </div>
        </div>
    </div>


<script>
document.addEventListener('DOMContentLoaded', () => {

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./service-worker.js')
                .then(registration => console.log('ServiceWorker registration successful'))
                .catch(err => console.log('ServiceWorker registration failed: ', err));
        });
    }

    const App = {
        currentUser: null,
        data: { users: [], products: [], sales: [], stockIns: [], stockOuts: [], stores: [] },
        cart: [],
        summaryContext: {},
        editingSaleContext: null,
        
        init() { this.loadData(); this.fillPages(); this.attachEventListeners(); this.checkLoginState(); },

        formatNumberSmart(num) {
            if (typeof num !== 'number' || isNaN(num)) return num;
            if (num % 1 === 0) {
                return num.toLocaleString('th-TH');
            } else {
                return num.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }
        },

        formatThaiDateShortYear(dateStr) {
            if (!dateStr) return '-';
            try {
                const date = new Date(dateStr);
                const year = new Intl.DateTimeFormat('th-TH-u-ca-buddhist', { year: 'numeric' }).format(date);
                const shortYear = year.slice(-2);
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${day}/${month}/${shortYear}`;
            } catch (e) {
                console.error("Date formatting error:", e);
                return '-';
            }
        },
        
        formatThaiDateFullYear(dateStr) {
            if (!dateStr) return '-';
            try {
                const date = new Date(dateStr);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear() + 543;
                return `${day}/${month}/${year}`;
            } catch (e) {
                console.error("Date formatting error:", e);
                return '-';
            }
        },

        formatThaiTimestamp(date) {
            if (!(date instanceof Date)) {
                date = new Date(date);
            }
            if (isNaN(date)) return '-';

            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear() + 543;
            const dateString = `${day}/${month}/${year}`;

            const timeString = date.toLocaleTimeString('th-TH', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });

            return `วันที่ ${dateString} เวลา ${timeString} น.`;
        },

        toggleSection(sectionId) {
            const currentlyOpen = document.querySelector('.section-content.active');
            if (currentlyOpen && currentlyOpen.id !== sectionId) {
                currentlyOpen.classList.remove('active');
                currentlyOpen.previousElementSibling.classList.remove('active');
            }
            const section = document.getElementById(sectionId);
            if (section) {
                const header = section.previousElementSibling;
                section.classList.toggle('active');
                header.classList.toggle('active');
            }
        },

        showPage(pageId, payload = null) {
            const sellerAllowedPages = ['page-pos', 'page-data'];
            const section = document.getElementById(pageId);
            if (!section) return;

            if (this.currentUser.role === 'seller' && !sellerAllowedPages.includes(pageId)) {
                this.showToast('คุณไม่มีสิทธิ์เข้าถึงหน้านี้');
                return;
            }

            const wasActive = section.classList.contains('active');
            
            if (!wasActive) {
                const isAdmin = this.currentUser.role === 'admin';
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = isAdmin ? '' : 'none');
                document.querySelectorAll('.seller-only').forEach(el => el.style.display = !isAdmin ? '' : 'none');
                switch (pageId) {
                    case 'page-pos': this.renderPos(payload); break;
                    case 'page-products': this.renderProductTable(); break;
                    case 'page-stock-in': this.renderStockIn(); break;
                    case 'page-stock-out': this.renderStockOut(); break;
                    case 'page-sales-history': this.renderSalesHistory(); break;
                    case 'page-reports': this.renderReport(); break;
                    case 'page-summary': this.renderSummaryPage(); break;
                    case 'page-stores': this.renderStoreTable(); break; 
                    case 'page-users': this.renderUserTable(); break;
                    case 'page-data':
                        if (this.currentUser.role === 'seller') {
                            this.renderSellerSalesHistoryWithFilter();
                        }
                        break;
                }
            }
            
            this.toggleSection(pageId);
        },
        
        showMainApp() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            document.getElementById('user-info').textContent = `ผู้ใช้: ${this.currentUser.username} (${this.currentUser.role})`;

            const storeNameSpan = document.getElementById('store-display-name');
            if (this.currentUser.role === 'seller' && this.currentUser.storeId) {
                const store = this.data.stores.find(s => s.id === this.currentUser.storeId);
                if (store) {
                    storeNameSpan.textContent = `- ${store.name}`;
                } else {
                    storeNameSpan.textContent = '';
                }
            } else {
                 storeNameSpan.textContent = '';
            }
            
            document.querySelectorAll('.section-content.active').forEach(openSection => {
                openSection.classList.remove('active');
                openSection.previousElementSibling.classList.remove('active');
            });
            this.showPage('page-pos');
        },
        
        loadData() { 
            const data = localStorage.getItem('posData'); 
            if (data) { 
                this.data = JSON.parse(data); 
                // Initialize new/missing data structures for backward compatibility
                if (!this.data.stores) { this.data.stores = []; } 
                if (!this.data.stockOuts) { this.data.stockOuts = []; } 
                if (this.data.sales && this.data.sales.length > 0) { 
                    this.data.sales.forEach(sale => { 
                        sale.items.forEach(item => { if (typeof item.isSpecialPrice === 'undefined') { item.isSpecialPrice = false; item.originalPrice = item.price; } }); 
                        if (sale.paymentMethod === 'เครดิต' && typeof sale.creditDueDate === 'undefined') { sale.creditDueDate = null; } 
                        if (typeof sale.transferorName === 'undefined') { sale.transferorName = null; } 
                    }); 
                } 
                this.data.users.forEach(u => { 
                    if (!u.storeId) { u.storeId = null; } 
                    if (u.role === 'seller') { 
                        if (!u.assignedProductIds) { u.assignedProductIds = []; } 
                        if (typeof u.salesStartDate === 'undefined') { u.salesStartDate = null; } 
                        if (typeof u.salesEndDate === 'undefined') { u.salesEndDate = null; } 
                        // NEW: Add commission defaults for backward compatibility
                        if (typeof u.commissionRate === 'undefined') { u.commissionRate = 0; }
                        if (typeof u.commissionOnCash === 'undefined') { u.commissionOnCash = false; }
                        if (typeof u.commissionOnTransfer === 'undefined') { u.commissionOnTransfer = false; }
                        if (typeof u.commissionOnCredit === 'undefined') { u.commissionOnCredit = false; }
                        // NEW: Add visibleSalesDays for backward compatibility
                        if (typeof u.visibleSalesDays === 'undefined') { u.visibleSalesDays = null; }
                    } 
                }); 
            } else { 
                this.data.users.push({ id: Date.now(), username: 'admin', password: '123', role: 'admin' }); 
                this.saveData(); 
            } 
        },
        saveData() { localStorage.setItem('posData', JSON.stringify(this.data)); },
        
        checkLoginState() {
            const rememberedUserJson = localStorage.getItem('posCurrentUser');
            if (rememberedUserJson) {
                const rememberedUser = JSON.parse(rememberedUserJson);
                this.currentUser = this.data.users.find(u => u.id === rememberedUser.id);
                if (this.currentUser) {
                    this.showMainApp();
                    return;
                }
            }

            const sessionUserJson = sessionStorage.getItem('posCurrentUser');
            if (sessionUserJson) {
                const sessionUser = JSON.parse(sessionUserJson);
                this.currentUser = this.data.users.find(u => u.id === sessionUser.id);
                if (this.currentUser) {
                    this.showMainApp();
                } else {
                    this.logout();
                }
            } else {
                this.showLoginScreen();
            }
        },
        login(username, password) {
            const user = this.data.users.find(u => u.username === username && u.password === password);
            if (user) {
                this.currentUser = user;
                const rememberMe = document.getElementById('remember-me').checked;

                sessionStorage.removeItem('posCurrentUser');
                localStorage.removeItem('posCurrentUser');

                if (rememberMe) {
                    localStorage.setItem('posCurrentUser', JSON.stringify(this.currentUser));
                } else {
                    sessionStorage.setItem('posCurrentUser', JSON.stringify(this.currentUser));
                }

                this.showMainApp();
                document.getElementById('login-error').textContent = '';
            } else {
                document.getElementById('login-error').textContent = 'ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง';
            }
        },
        logout() {
            this.currentUser = null;
            sessionStorage.removeItem('posCurrentUser');
            localStorage.removeItem('posCurrentUser');
            this.showLoginScreen();
        },

        showLoginScreen() { document.getElementById('login-screen').style.display = 'block'; document.getElementById('main-app').style.display = 'none'; },
        showToast(message, type = 'success') { const toast = document.getElementById('toast-notification'); if (!toast) return; toast.textContent = message; toast.style.backgroundColor = type === 'error' ? 'var(--danger-color)' : (type === 'warning' ? 'var(--warning-color)' : 'var(--success-color)'); toast.className = 'show'; setTimeout(() => { toast.className = toast.className.replace('show', ''); }, 3000); },
        openSummaryModal(htmlContent) { const modal = document.getElementById('summaryModal'); const modalBody = document.getElementById('modalBodyContent'); modalBody.innerHTML = htmlContent; modal.style.display = 'flex'; },
        closeSummaryModal() { document.getElementById('summaryModal').style.display = 'none'; },
        openSummaryOutputModal() { document.getElementById('summaryOutputModal').style.display = 'flex'; },
        closeSummaryOutputModal() { document.getElementById('summaryOutputModal').style.display = 'none'; this.summaryContext = {}; },
        
        handleSummaryOutput(choice) {
            if (!this.summaryContext || (!this.summaryContext.summaryResult && !this.summaryContext.creditData && !this.summaryContext.transferData)) {
                this.closeSummaryOutputModal();
                return;
            }
            if (this.summaryContext.type === 'credit') {
                if (choice === 'display') {
                    const html = this.buildCreditSummaryHtml(this.summaryContext);
                    this.openSummaryModal(html);
                } else if (choice === 'csv') {
                    this.exportCreditSummaryToCsv(this.summaryContext);
                }
            } else if (this.summaryContext.type === 'transfer') {
                if (choice === 'display') {
                    const html = this.buildTransferSummaryHtml(this.summaryContext);
                    this.openSummaryModal(html);
                } else if (choice === 'csv') {
                    this.exportTransferSummaryToCsv(this.summaryContext);
                }
            } else { // POS Summary
                if (choice === 'display') {
                    const html = this.buildPosSummaryHtml(this.summaryContext);
                    this.openSummaryModal(html);
                } else if (choice === 'csv') {
                    this.exportPosSummaryToCsv(this.summaryContext);
                }
            }
            this.closeSummaryOutputModal();
        },

        renderSummaryPage() {
            const creditSellerSelect = document.getElementById('summary-credit-seller');
            const transferSellerSelect = document.getElementById('summary-transfer-seller');

            const populateSelect = (selectElement) => {
                if (selectElement) {
                    selectElement.innerHTML = '<option value="all">-- ผู้ขายทั้งหมด --</option>';
                    this.data.users.forEach(user => {
                        selectElement.innerHTML += `<option value="${user.id}">${user.username}</option>`;
                    });
                }
            };
            
            populateSelect(creditSellerSelect);
            populateSelect(transferSellerSelect);
        },

        _runSummary(startDate, endDate, title, periodName, sellerId = null) { const summaryResult = this.generatePosSummaryData(startDate, endDate, sellerId); if (summaryResult.salesCount === 0) { this.showToast("ไม่พบข้อมูลการขายในช่วงที่กำหนด"); return; } const isSingleDay = (startDate.getFullYear() === endDate.getFullYear() && startDate.getMonth() === endDate.getMonth() && startDate.getDate() === endDate.getDate()); const thaiDateString = isSingleDay ? this.formatThaiDateShortYear(startDate) : `${this.formatThaiDateShortYear(startDate)} ถึง ${this.formatThaiDateShortYear(endDate)}`; const dateString = `${startDate.toISOString().split('T')[0]} to ${endDate.toISOString().split('T')[0]}`; this.summaryContext = { summaryResult, title, dateString, thaiDateString, periodName, sellerIdFilter: sellerId, startDate, endDate }; this.openSummaryOutputModal(); },
        summarizeToday() { const todayStart = new Date(); todayStart.setHours(0, 0, 0, 0); const todayEnd = new Date(); todayEnd.setHours(23, 59, 59, 999); this._runSummary(todayStart, todayEnd, "สรุปข้อมูลของวันนี้", "Today"); },
        summarizeAll() { if (this.data.sales.length === 0) { this.showToast("ยังไม่มีข้อมูลการขาย"); return; } const allDates = this.data.sales.map(s => new Date(s.date)); const startDate = new Date(Math.min.apply(null, allDates)); startDate.setHours(0, 0, 0, 0); const endDate = new Date(Math.max.apply(null, allDates)); endDate.setHours(23, 59, 59, 999); this._runSummary(startDate, endDate, "สรุปข้อมูลทั้งหมด", "All"); },
        summarizeByDay() { const dateStr = document.getElementById('summary-single-date').value; if (!dateStr) { this.showToast("กรุณาเลือกวันที่"); return; } const startDate = new Date(dateStr); startDate.setHours(0, 0, 0, 0); const endDate = new Date(dateStr); endDate.setHours(23, 59, 59, 999); this._runSummary(startDate, endDate, "สรุปข้อมูลของวันที่เลือก", `Date_${dateStr}`); },
        summarizeByRange() { let startDateStr = document.getElementById('summary-range-start').value; let endDateStr = document.getElementById('summary-range-end').value; if (!startDateStr || !endDateStr) { this.showToast("กรุณาเลือกวันที่เริ่มต้นและสิ้นสุด"); return; } let startDate = new Date(startDateStr); startDate.setHours(0, 0, 0, 0); let endDate = new Date(endDateStr); endDate.setHours(23, 59, 59, 999); if (startDate > endDate) { this.showToast("วันที่เริ่มต้นต้องมาก่อนวันที่สิ้นสุด"); return; } this._runSummary(startDate, endDate, "สรุปข้อมูลตามช่วงวันที่", `Range_${startDateStr}_to_${endDateStr}`); },
        summarizeMyToday() { const todayStart = new Date(); todayStart.setHours(0, 0, 0, 0); const todayEnd = new Date(); todayEnd.setHours(23, 59, 59, 999); this._runSummary(todayStart, todayEnd, `สรุปยอดขายวันนี้ (${this.currentUser.username})`, `MyToday`, this.currentUser.id); },
        summarizeMyDay() { const dateStr = document.getElementById('my-summary-date').value; if (!dateStr) { this.showToast("กรุณาเลือกวันที่"); return; } const startDate = new Date(dateStr); startDate.setHours(0, 0, 0, 0); const endDate = new Date(dateStr); endDate.setHours(23, 59, 59, 999); this._runSummary(startDate, endDate, `สรุปยอดขายวันที่เลือก (${this.currentUser.username})`, `MyDate_${dateStr}`, this.currentUser.id); },
        summarizeMyAll() { const mySales = this.data.sales.filter(s => s.sellerId === this.currentUser.id); if (mySales.length === 0) { this.showToast("คุณยังไม่มีข้อมูลการขาย"); return; } const allMyDates = mySales.map(s => new Date(s.date)); const startDate = new Date(Math.min.apply(null, allMyDates)); startDate.setHours(0, 0, 0, 0); const endDate = new Date(); endDate.setHours(23, 59, 59, 999); this._runSummary(startDate, endDate, `สรุปยอดขายทั้งหมด (${this.currentUser.username})`, `MyAll`, this.currentUser.id); },
        
        buildCreditSummaryHtml(context) {
            const { creditData } = context;
            const { filteredCreditSales, sellerName, startDate, endDate, summaryTimestamp } = creditData;
            
            const formatCurrency = (num) => this.formatNumberSmart(num);
            const formatDate = (dateStr) => this.formatThaiDateShortYear(dateStr);
            
            let totalCredit = 0;
            let creditRows = '';
            [...filteredCreditSales].sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(s => {
                totalCredit += s.total;
                const itemsList = s.items.map(item => { 
                    const product = this.data.products.find(p => p.id === item.productId); 
                    const unit = product ? product.unit : 'หน่วย'; 
                    return `${item.name}(${this.formatNumberSmart(item.quantity)} ${unit})`; 
                }).join(', ');
                
                creditRows += `<tr>
                    <td data-label="วันที่">${formatDate(s.date)}</td>
                    <td data-label="ผู้ซื้อ">${s.buyerName || '-'}</td>
                    <td data-label="ผู้ขาย">${s.sellerName || '-'}</td>
                    <td data-label="รายการ">${itemsList}</td>
                    <td data-label="ยอดเงิน(บาท)">${formatCurrency(s.total)}</td>
                    <td data-label="กำหนดชำระ">${formatDate(s.creditDueDate)}</td>
                </tr>`;
            });

            const periodLine = `<p style="font-size:0.9em; color: #333; font-weight: bold; margin-bottom: 8px;">ช่วงวันที่ : ${formatDate(startDate)} ถึงวันที่ ${formatDate(endDate)}</p>`;
            
            return `
                <div style="text-align:center;">
                    <h2>สรุปรายการลูกหนี้ทั้งหมดของ: ${sellerName}</h2>
                    <p style="font-size:0.8em; color:#555; margin-bottom: 0;">สรุปเมื่อ : ${summaryTimestamp}</p>
                    ${periodLine}
                    <table class="credit-details-table" style="margin-top: 15px;">
                        <thead><tr><th>วันที่</th><th>ผู้ซื้อ</th><th>ผู้ขาย</th><th>รายการ</th><th>ยอดเงิน(บาท)</th><th>กำหนดชำระ</th></tr></thead>
                        <tbody>${creditRows}</tbody>
                    </table>
                    <p style="text-align:right; font-size:1.2em; font-weight:bold; margin-top:15px;">ยอดรวมลูกหนี้ทั้งหมด : ${formatCurrency(totalCredit)} บาท</p>
                </div>
            `;
        },

        summarizeAllCreditByAdmin() {
            const sellerId = document.getElementById('summary-credit-seller').value;
            const startDateStr = document.getElementById('summary-credit-start-date').value;
            const endDateStr = document.getElementById('summary-credit-end-date').value;

            if (!startDateStr || !endDateStr) {
                this.showToast("กรุณาเลือกวันที่เริ่มต้นและสิ้นสุด");
                return;
            }

            const startDate = new Date(startDateStr);
            startDate.setHours(0, 0, 0, 0);
            const endDate = new Date(endDateStr);
            endDate.setHours(23, 59, 59, 999);
            
            if (startDate > endDate) {
                this.showToast("วันที่เริ่มต้นต้องมาก่อนวันที่สิ้นสุด");
                return;
            }

            const filteredCreditSales = this.data.sales.filter(s => {
                if (s.paymentMethod !== 'เครดิต') return false;
                if (sellerId !== 'all' && s.sellerId != sellerId) return false;
                const saleDate = new Date(s.date);
                return saleDate >= startDate && saleDate <= endDate;
            });

            if (filteredCreditSales.length === 0) {
                this.showToast("ไม่พบข้อมูลลูกหนี้ (เครดิต) ตามเงื่อนไขที่เลือก");
                return;
            }
            
            const summaryTimestamp = this.formatThaiTimestamp(new Date());
            const selectedSeller = this.data.users.find(u => u.id == sellerId);
            const sellerName = sellerId === 'all' ? 'ผู้ขายทั้งหมด' : (selectedSeller ? selectedSeller.username : 'ไม่พบผู้ขาย');

            this.summaryContext = {
                type: 'credit',
                creditData: {
                    filteredCreditSales,
                    sellerName,
                    startDate,
                    endDate,
                    summaryTimestamp
                },
                title: `สรุปรายการลูกหนี้ของ ${sellerName}`,
                periodName: `Credit_${sellerId}_${startDateStr}_to_${endDateStr}`
            };
            this.openSummaryOutputModal();
        },
        
        summarizeMyAllCredit() {
            const sellerStartDate = this.currentUser.salesStartDate ? new Date(this.currentUser.salesStartDate) : null;
            if (sellerStartDate) sellerStartDate.setHours(0, 0, 0, 0);

            const sellerEndDate = this.currentUser.salesEndDate ? new Date(this.currentUser.salesEndDate) : null;
            if (sellerEndDate) sellerEndDate.setHours(23, 59, 59, 999);

            const myCreditSales = this.data.sales.filter(s => {
                if (s.sellerId !== this.currentUser.id || s.paymentMethod !== 'เครดิต') {
                    return false;
                }
                const saleDate = new Date(s.date);
                if (sellerStartDate && saleDate < sellerStartDate) {
                    return false;
                }
                if (sellerEndDate && saleDate > sellerEndDate) {
                    return false;
                }
                return true;
            });

            if (myCreditSales.length === 0) {
                this.showToast("ไม่พบข้อมูลลูกหนี้ (เครดิต) ในช่วงเวลาที่กำหนด");
                return;
            }

            let reportStartDate, reportEndDate;

            if (sellerStartDate) {
                reportStartDate = sellerStartDate;
            } else {
            const allDates = myCreditSales.map(s => new Date(s.date));
                reportStartDate = new Date(Math.min.apply(null, allDates));
                reportStartDate.setHours(0,0,0,0);
            }
            
            if (sellerEndDate) {
                reportEndDate = sellerEndDate;
            } else {
                const allDates = myCreditSales.map(s => new Date(s.date));
                reportEndDate = new Date(Math.max.apply(null, allDates));
                reportEndDate.setHours(23,59,59,999);
            }

            const summaryTimestamp = this.formatThaiTimestamp(new Date());
            const sellerName = this.currentUser.username;

            this.summaryContext = {
                type: 'credit',
                creditData: {
                    filteredCreditSales: myCreditSales,
                    sellerName,
                    startDate: reportStartDate,
                    endDate: reportEndDate,
                    summaryTimestamp
                },
                title: `สรุปรายการลูกหนี้ทั้งหมดของ ${sellerName}`,
                periodName: `MyCredit_All_${this.currentUser.id}`
            };
            this.openSummaryOutputModal();
        },

        summarizeAllTransfersByAdmin() {
            const sellerId = document.getElementById('summary-transfer-seller').value;
            const startDateStr = document.getElementById('summary-transfer-start-date').value;
            const endDateStr = document.getElementById('summary-transfer-end-date').value;

            if (!startDateStr || !endDateStr) {
                this.showToast("กรุณาเลือกวันที่เริ่มต้นและสิ้นสุด");
                return;
            }

            const startDate = new Date(startDateStr);
            startDate.setHours(0, 0, 0, 0);
            const endDate = new Date(endDateStr);
            endDate.setHours(23, 59, 59, 999);
            
            if (startDate > endDate) {
                this.showToast("วันที่เริ่มต้นต้องมาก่อนวันที่สิ้นสุด");
                return;
            }

            const filteredTransferSales = this.data.sales.filter(s => {
                if (s.paymentMethod !== 'เงินโอน') return false;
                if (sellerId !== 'all' && s.sellerId != sellerId) return false;
                const saleDate = new Date(s.date);
                return saleDate >= startDate && saleDate <= endDate;
            });

            if (filteredTransferSales.length === 0) {
                this.showToast("ไม่พบข้อมูลเงินโอนตามเงื่อนไขที่เลือก");
                return;
            }
            
            const summaryTimestamp = this.formatThaiTimestamp(new Date());
            const selectedSeller = this.data.users.find(u => u.id == sellerId);
            const sellerName = sellerId === 'all' ? 'ผู้ขายทั้งหมด' : (selectedSeller ? selectedSeller.username : 'ไม่พบผู้ขาย');

            this.summaryContext = {
                type: 'transfer',
                transferData: {
                    filteredTransferSales,
                    sellerName,
                    startDate,
                    endDate,
                    summaryTimestamp
                },
                title: `สรุปรายการเงินโอนของ ${sellerName}`,
                periodName: `Transfer_${sellerId}_${startDateStr}_to_${endDateStr}`
            };
            this.openSummaryOutputModal();
        },

        summarizeMyAllTransfers() {
            const sellerStartDate = this.currentUser.salesStartDate ? new Date(this.currentUser.salesStartDate) : null;
            if (sellerStartDate) sellerStartDate.setHours(0, 0, 0, 0);

            const sellerEndDate = this.currentUser.salesEndDate ? new Date(this.currentUser.salesEndDate) : null;
            if (sellerEndDate) sellerEndDate.setHours(23, 59, 59, 999);

            const myTransferSales = this.data.sales.filter(s => {
                if (s.sellerId !== this.currentUser.id || s.paymentMethod !== 'เงินโอน') {
                    return false;
                }
                const saleDate = new Date(s.date);
                if (sellerStartDate && saleDate < sellerStartDate) {
                    return false;
                }
                if (sellerEndDate && saleDate > sellerEndDate) {
                    return false;
                }
                return true;
            });

            if (myTransferSales.length === 0) {
                this.showToast("ไม่พบข้อมูลเงินโอนในช่วงเวลาที่กำหนด");
                return;
            }

            let reportStartDate, reportEndDate;

            if (sellerStartDate) {
                reportStartDate = sellerStartDate;
            } else {
                const allDates = myTransferSales.map(s => new Date(s.date));
                reportStartDate = new Date(Math.min.apply(null, allDates));
                reportStartDate.setHours(0,0,0,0);
            }
            
            if (sellerEndDate) {
                reportEndDate = sellerEndDate;
            } else {
                const allDates = myTransferSales.map(s => new Date(s.date));
                reportEndDate = new Date(Math.max.apply(null, allDates));
                reportEndDate.setHours(23,59,59,999);
            }

            const summaryTimestamp = this.formatThaiTimestamp(new Date());
            const sellerName = this.currentUser.username;

            this.summaryContext = {
                type: 'transfer',
                transferData: {
                    filteredTransferSales: myTransferSales,
                    sellerName,
                    startDate: reportStartDate,
                    endDate: reportEndDate,
                    summaryTimestamp
                },
                title: `สรุปรายการเงินโอนทั้งหมดของ ${sellerName}`,
                periodName: `MyTransfer_All_${this.currentUser.id}`
            };
            this.openSummaryOutputModal();
        },

        buildTransferSummaryHtml(context) {
            const { transferData } = context;
            const { filteredTransferSales, sellerName, startDate, endDate, summaryTimestamp } = transferData;
            
            const formatCurrency = (num) => this.formatNumberSmart(num);
            const formatDate = (dateStr) => this.formatThaiDateShortYear(dateStr);
            
            let totalTransfer = 0;
            let transferRows = '';
            [...filteredTransferSales].sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(s => {
                totalTransfer += s.total;
                const itemsList = s.items.map(item => { 
                    const product = this.data.products.find(p => p.id === item.productId); 
                    const unit = product ? product.unit : 'หน่วย'; 
                    return `${item.name}(${this.formatNumberSmart(item.quantity)} ${unit})`; 
                }).join(', ');
                
                transferRows += `<tr>
                    <td data-label="วันที่">${formatDate(s.date)}</td>
                    <td data-label="ผู้โอน">${s.transferorName || '-'}</td>
                    <td data-label="ผู้ขาย">${s.sellerName || '-'}</td>
                    <td data-label="รายการ">${itemsList}</td>
                    <td data-label="ยอดเงิน(บาท)">${formatCurrency(s.total)}</td>
                </tr>`;
            });

            const periodLine = `<p style="font-size:0.9em; color: #333; font-weight: bold; margin-bottom: 8px;">ช่วงวันที่ : ${formatDate(startDate)} ถึงวันที่ ${formatDate(endDate)}</p>`;
            
            return `
                <div style="text-align:center;">
                    <h2>สรุปรายการเงินโอนทั้งหมดของ: ${sellerName}</h2>
                    <p style="font-size:0.8em; color:#555; margin-bottom: 0;">สรุปเมื่อ : ${summaryTimestamp}</p>
                    ${periodLine}
                    <table class="transfer-details-table" style="margin-top: 15px;">
                        <thead><tr><th>วันที่</th><th>ผู้โอน</th><th>ผู้ขาย</th><th>รายการ</th><th>ยอดเงิน(บาท)</th></tr></thead>
                        <tbody>${transferRows}</tbody>
                    </table>
                    <p style="text-align:right; font-size:1.2em; font-weight:bold; margin-top:15px;">ยอดรวมเงินโอนทั้งหมด: ${formatCurrency(totalTransfer)} บาท</p>
                </div>
            `;
        },

        exportTransferSummaryToCsv(context) {
            const { transferData, periodName } = context;
            const { filteredTransferSales, sellerName, startDate, endDate } = transferData;
            let csvRows = [];
            
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear() + 543;
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const summaryDateTime = `${day}/${month}/${year} ${hours}:${minutes} น.`;
            
            const formatCurrency = (num) => this.formatNumberSmart(num);
            const formatDate = (dateStr) => this.formatThaiDateShortYear(dateStr);
            const periodString = `${formatDate(startDate)} ถึง ${formatDate(endDate)}`;

            csvRows.push(['สรุปโดย :', this.currentUser.username]);
            csvRows.push(['สรุปเมื่อ :', summaryDateTime]);
            csvRows.push([`สรุปรายการเงินโอนของ ${sellerName}:`, periodString]);
            csvRows.push([]);

            csvRows.push(['วันที่', 'ผู้โอน', 'ผู้ขาย', 'รายการสินค้า', 'ยอดเงิน(บาท)']);
            
            let totalTransfer = 0;
            [...filteredTransferSales].sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(s => {
                totalTransfer += s.total;
                const itemsList = s.items.map(item => { 
                    const product = this.data.products.find(p => p.id === item.productId); 
                    const unit = product ? product.unit : 'หน่วย'; 
                    return `${item.name}(${this.formatNumberSmart(item.quantity)} ${unit})`; 
                }).join('; ');
                
                csvRows.push([
                    formatDate(s.date),
                    s.transferorName || '-',
                    s.sellerName || '-',
                    itemsList,
                    formatCurrency(s.total)
                ]);
            });

            csvRows.push([]);
            csvRows.push(['', '', '', 'ยอดรวมเงินโอนทั้งหมด (บาท)', formatCurrency(totalTransfer)]);

            const csvContent = csvRows.map(row => row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')).join("\n");
            const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=utf-8;" });
            const fileName = `Transfer_Summary_${periodName}_${new Date().getTime()}.csv`;
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            link.click();
            URL.revokeObjectURL(link.href);
            this.showToast(`ส่งออกไฟล์ CSV '${fileName}' สำเร็จ`);
        },

        generatePosSummaryData(startDate, endDate, sellerIdFilter = null) {
            const summary = { grandTotalSales: 0, grandTotalProfit: 0, grandTotalCash: 0, grandTotalCredit: 0, grandTotalTransfer: 0, salesCount: 0, sellerSummary: {}, totalSellingDays: 0 };
            let salesToProcess = this.data.sales;
            if (sellerIdFilter) {
                salesToProcess = salesToProcess.filter(s => s.sellerId === sellerIdFilter);
            }
            const filteredSales = salesToProcess.filter(sale => {
                const saleDate = new Date(sale.date);
                if (saleDate < startDate || saleDate > endDate) { return false; }
                const seller = this.data.users.find(u => u.id === sale.sellerId);
                if (seller && seller.role === 'seller') {
                    if (seller.salesStartDate) {
                        const sellerStartDate = new Date(seller.salesStartDate);
                        sellerStartDate.setHours(0, 0, 0, 0);
                        if (saleDate < sellerStartDate) { return false; }
                    }
                    if (seller.salesEndDate) {
                        const sellerEndDate = new Date(seller.salesEndDate);
                        sellerEndDate.setHours(23, 59, 59, 999);
                        if (saleDate > sellerEndDate) { return false; }
                    }
                }
                return true;
            });
            summary.salesCount = filteredSales.length;
            filteredSales.forEach(sale => {
                const sellerId = sale.sellerId || 'unknown';
                if (!summary.sellerSummary[sellerId]) {
                    summary.sellerSummary[sellerId] = { sellerName: sale.sellerName || 'ไม่ระบุ', totalSales: 0, totalProfit: 0, totalCash: 0, totalCredit: 0, totalTransfer: 0, productSummary: {} };
                }
                const sellerData = summary.sellerSummary[sellerId];
                sellerData.totalSales += sale.total;
                sellerData.totalProfit += sale.profit;
                summary.grandTotalSales += sale.total;
                summary.grandTotalProfit += sale.profit;

                const paymentType = sale.paymentMethod || 'เงินสด';
                if (paymentType === 'เครดิต') {
                    summary.grandTotalCredit += sale.total;
                    sellerData.totalCredit += sale.total;
                } else if (paymentType === 'เงินโอน') {
                    summary.grandTotalTransfer += sale.total;
                    sellerData.totalTransfer += sale.total;
                } else {
                    summary.grandTotalCash += sale.total;
                    sellerData.totalCash += sale.total;
                }

                sale.items.forEach(item => {
                    const productId = item.productId;
                    if (!sellerData.productSummary[productId]) {
                        const productInfo = this.data.products.find(p => p.id === productId);
                        sellerData.productSummary[productId] = { name: item.name, stock: productInfo ? productInfo.stock : 'N/A', unit: productInfo ? productInfo.unit : 'หน่วย', cashQty: 0, creditQty: 0, transferQty: 0, totalQty: 0, totalValue: 0, };
                    }
                    const productSum = sellerData.productSummary[productId];
                    productSum.totalQty += item.quantity;
                    productSum.totalValue += (item.price * item.quantity);
                    if (paymentType === 'เครดิต') {
                        productSum.creditQty += item.quantity;
                    } else if (paymentType === 'เงินโอน') {
                        productSum.transferQty += item.quantity;
                    } else {
                        productSum.cashQty += item.quantity;
                    }
                });
            });
            
            const uniqueSaleDays = new Set();
            filteredSales.forEach(sale => {
                const datePart = sale.date.split('T')[0];
                uniqueSaleDays.add(datePart);
            });
            summary.totalSellingDays = uniqueSaleDays.size;

            return summary;
        },
        
        buildPosSummaryHtml(context) {
            const { summaryResult, title, thaiDateString, sellerIdFilter, startDate, endDate } = context;
            const isSingleDayReport = startDate.getFullYear() === endDate.getFullYear() && startDate.getMonth() === endDate.getMonth() && startDate.getDate() === endDate.getDate();
            const formatCurrency = (num) => this.formatNumberSmart(num);
            
            let dateDisplayString = thaiDateString;
            if (isSingleDayReport) {
                const fullDate = this.formatThaiDateFullYear(startDate);
                dateDisplayString = ` ${fullDate}`;
            }

            const summaryTimestamp = this.formatThaiTimestamp(new Date());

            const isSellerReport = !!sellerIdFilter;
            let allSellersHtml = '';
            let overallSummaryHtml = '';
            
            if (this.currentUser.role === 'admin' && !isSellerReport) {
                overallSummaryHtml = `
                    <div style="text-align:center;">
                        <h2>${title}</h2>
                        <p style="font-size:0.8em; color:#555; margin-bottom: 0;">สรุปโดย : ${this.currentUser.username} | สรุปเมื่อ : ${summaryTimestamp}</p>
                        <p style="font-size:0.9em; color:#333; font-weight:bold; margin-bottom: 8px;">วันที่ขายสินค้า : ${dateDisplayString}</p>
                    </div>
                    <hr><h2>ภาพรวมทั้งหมด</h2>
                    <p><strong>ยอดเงินสด :</strong> ${formatCurrency(summaryResult.grandTotalCash)} บาท</p>
                    <p><strong>ยอดเงินโอน :</strong> ${formatCurrency(summaryResult.grandTotalTransfer)} บาท</p>
                    <p><strong>ยอดเครดิต :</strong> ${formatCurrency(summaryResult.grandTotalCredit)} บาท</p>
                    <p><strong>ยอดขายรวมทั้งหมด: ${formatCurrency(summaryResult.grandTotalSales)} บาท</strong></p>
                    ${!isSingleDayReport ? `<p><strong>จำนวนวันขายทั้งหมด : ${summaryResult.totalSellingDays} วัน</strong></p>` : ''}
                    <p style="font-weight: bold; font-size: 1.2em; color: ${summaryResult.grandTotalProfit >= 0 ? 'green' : 'red'};">
                        <strong>กำไรสุทธิรวม: ${formatCurrency(summaryResult.grandTotalProfit)} บาท</strong>
                    </p>`;
            }

            const sellerKeys = Object.keys(summaryResult.sellerSummary);
            if (this.currentUser.role === 'admin' && !isSellerReport && sellerKeys.length > 0) {
                 allSellersHtml += `<hr style="border-top: 2px solid #333;"><h2 style="border-bottom-color: #607d8b;">รายละเอียดแยกตามผู้ขาย</h2>`;
            }

            sellerKeys.forEach((sellerId) => {
                const sellerData = summaryResult.sellerSummary[sellerId];
                const sectionTitle = isSellerReport ? title : `สรุปยอดขาย: ${sellerData.sellerName}`;
                let productTableRows = '';
                Object.values(sellerData.productSummary).forEach(p => {
                    const formattedStock = p.stock === 'N/A' ? 'N/A' : this.formatNumberSmart(p.stock);
                    productTableRows += `<tr><td data-label="สินค้า">${p.name}</td><td data-label="ขายเงินสด">${this.formatNumberSmart(p.cashQty)} ${p.unit}</td><td data-label="ขายเงินโอน">${this.formatNumberSmart(p.transferQty)} ${p.unit}</td><td data-label="ขายเครดิต">${this.formatNumberSmart(p.creditQty)} ${p.unit}</td><td data-label="รวม">${this.formatNumberSmart(p.totalQty)} ${p.unit}</td><td data-label="ยอดขาย (บาท)">${formatCurrency(p.totalValue)}</td><td data-label="สต็อกคงเหลือ">${formattedStock} ${p.unit}</td></tr>`;
                });

                let profitOrCommissionHtml;
                if (isSellerReport) {
                    const sellerUser = this.data.users.find(u => u.id == sellerId);
                    let commission = 0;
                    let commissionText = 'ไม่มีคอมมิชชั่น';

                    if (sellerUser && sellerUser.commissionRate > 0) {
                        let commissionBase = 0;
                        let sources = [];
                        if (sellerUser.commissionOnCash) {
                            commissionBase += sellerData.totalCash;
                            sources.push('เงินสด');
                        }
                        if (sellerUser.commissionOnTransfer) {
                            commissionBase += sellerData.totalTransfer;
                            sources.push('เงินโอน');
                        }
                        if (sellerUser.commissionOnCredit) {
                            commissionBase += sellerData.totalCredit;
                            sources.push('เครดิต');
                        }
                        
                        commission = commissionBase * (sellerUser.commissionRate / 100);
                        
                        if (sources.length > 0) {
                            commissionText = `คิด ${sellerUser.commissionRate}% จากขาย${sources.join('+')} = ${formatCurrency(commission)} บาท`;
                        } else {
                            commissionText = `ตั้งค่าคอมมิชชั่น ${sellerUser.commissionRate}% แต่ไม่ได้เลือกประเภทการขาย`;
                        }
                    }
                    
                    profitOrCommissionHtml = `<p style="font-weight: bold; color: #007bff;"><strong>${commissionText}</strong></p>`;
                } else {
                    const profitColor = sellerData.totalProfit >= 0 ? 'green' : 'red';
                    profitOrCommissionHtml = `<p style="color: ${profitColor};"><strong>กำไรรวม: ${formatCurrency(sellerData.totalProfit)} บาท</strong></p>`;
                }

                let creditDetailsHtml = '';
                const creditSalesDetails = this.data.sales.filter(s => s.sellerId == sellerId && s.paymentMethod === 'เครดิต' && new Date(s.date) >= startDate && new Date(s.date) <= endDate);
                if (creditSalesDetails.length > 0) {
                    let creditRows = '';
                    creditSalesDetails.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(s => {
                        const itemsList = s.items.map(item => { const product = this.data.products.find(p => p.id === item.productId); const unit = product ? product.unit : 'หน่วย'; return `${item.name}( ${this.formatNumberSmart(item.quantity)} ${unit} )`; }).join(', ');
                        creditRows += `<tr><td data-label="วันที่">${this.formatThaiDateShortYear(s.date)}</td><td data-label="ผู้ซื้อ">${s.buyerName || '-'}</td><td data-label="รายการ">${itemsList}</td><td data-label="ยอดเงิน(บาท)">${formatCurrency(s.total)}</td><td data-label="กำหนดชำระ">${this.formatThaiDateShortYear(s.creditDueDate)}</td></tr>`;
                    });
                    creditDetailsHtml = `<div style="margin-top: 15px; text-align:center;"><h2>รายละเอียดลูกหนี้ (เครดิต)</h2><table class="credit-details-table credit-details-sub-table"><thead><tr><th>วันที่</th><th>ผู้ซื้อ</th><th>รายการ</th><th>ยอดเงิน(บาท)</th><th>กำหนดชำระ</th></tr></thead><tbody>${creditRows}</tbody></table></div>`;
                }

                let transferDetailsHtml = '';
                const transferSalesDetails = this.data.sales.filter(s => s.sellerId == sellerId && s.paymentMethod === 'เงินโอน' && new Date(s.date) >= startDate && new Date(s.date) <= endDate);
                if (transferSalesDetails.length > 0) {
                    let transferRows = '';
                    transferSalesDetails.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(s => {
                        const itemsList = s.items.map(item => { const product = this.data.products.find(p => p.id === item.productId); const unit = product ? product.unit : 'หน่วย'; return `${item.name}( ${this.formatNumberSmart(item.quantity)} ${unit} )`; }).join(', ');
                        transferRows += `<tr><td data-label="วันที่">${this.formatThaiDateShortYear(s.date)}</td><td data-label="ผู้โอน">${s.transferorName || '-'}</td><td data-label="รายการ">${itemsList}</td><td data-label="ยอดเงิน(บาท)">${formatCurrency(s.total)}</td></tr>`;
                    });
                    transferDetailsHtml = `<div style="margin-top: 15px; text-align:center;"><h2>รายละเอียดเงินโอน</h2><table class="transfer-details-table transfer-details-sub-table"><thead><tr><th>วันที่</th><th>ผู้โอน</th><th>รายการ</th><th>ยอดเงิน(บาท)</th></tr></thead><tbody>${transferRows}</tbody></table></div>`;
                }
                
                allSellersHtml += `
                    <div style="text-align:center; ${!isSellerReport ? 'margin-top: 20px;' : ''}">
                        <h2>${sectionTitle}</h2>
                        ${isSellerReport ? `<p style="font-size:0.8em; color:#555; margin-bottom: 0;">สรุปโดย : ${this.currentUser.username} | สรุปเมื่อ : ${summaryTimestamp}</p>` : ''}
                        <p style="font-size: 0.9em; color: #333; font-weight: bold; margin-bottom: 8px;">วันที่ขายสินค้า : ${dateDisplayString}</p>
                        <p style="margin-bottom: 8px;"><strong>ยอดขายรวม : ${formatCurrency(sellerData.totalSales)} บาท</strong> <br><span style="font-size:0.9em; color:#555;">(เงินสด : ${formatCurrency(sellerData.totalCash)} | เงินโอน : ${formatCurrency(sellerData.totalTransfer)} | เครดิต : ${formatCurrency(sellerData.totalCredit)})</span></p>
                        ${!isSingleDayReport ? `<p><strong>จำนวนวันขายทั้งหมด : ${summaryResult.totalSellingDays} วัน</strong></p>` : ''}
                        ${profitOrCommissionHtml}
                        <table class="product-summary-table">
                            <thead><tr><th>สินค้า</th><th>ขายเงินสด</th><th>ขายเงินโอน</th><th>ขายเครดิต</th><th>รวม(หน่วย)</th><th>ยอดขาย(บาท)</th><th>สต็อกคงเหลือ</th></tr></thead>
                            <tbody>${productTableRows}</tbody>
                        </table>
                        ${creditDetailsHtml}
                        ${transferDetailsHtml}
                    </div>`;
            });
            
            return `${overallSummaryHtml}${allSellersHtml || '<p>ไม่พบข้อมูลการขายในช่วงเวลานี้</p>'}`;
        },

        exportPosSummaryToCsv(context) {
            const { summaryResult, title, thaiDateString, periodName, sellerIdFilter, startDate, endDate } = context;
            const isSingleDayReport = startDate.getFullYear() === endDate.getFullYear() && startDate.getMonth() === endDate.getMonth() && startDate.getDate() === endDate.getDate();
            let csvRows = [];
            
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear() + 543;
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const summaryDateTime = `${day}/${month}/${year} ${hours}:${minutes} น.`;

            const isSellerReport = !!sellerIdFilter;

            csvRows.push(['สรุปโดย :', this.currentUser.username]);
            csvRows.push(['สรุปเมื่อ :', summaryDateTime]);
            const finalTitle = title.replace('ข้อมูล', 'ข้อมูลทั้งหมด');
            csvRows.push([finalTitle + ':', thaiDateString]);
            csvRows.push([]);

            if (this.currentUser.role === 'admin' && !isSellerReport) {
                csvRows.push(['--- ภาพรวมทั้งหมด ---']);
                csvRows.push(['ยอดเงินสด (บาท)', this.formatNumberSmart(summaryResult.grandTotalCash)]);
                csvRows.push(['ยอดเงินโอน (บาท)', this.formatNumberSmart(summaryResult.grandTotalTransfer)]);
                csvRows.push(['ยอดเครดิต (บาท)', this.formatNumberSmart(summaryResult.grandTotalCredit)]);
                csvRows.push(['ยอดขายรวมทั้งหมด (บาท)', this.formatNumberSmart(summaryResult.grandTotalSales)]);
                if (!isSingleDayReport) {
                    csvRows.push(['จำนวนวันขายทั้งหมด (วัน)', summaryResult.totalSellingDays]);
                }
                csvRows.push(['กำไรสุทธิรวม (บาท)', this.formatNumberSmart(summaryResult.grandTotalProfit)]);
                csvRows.push([]);
            }

            for (const sellerId in summaryResult.sellerSummary) {
                const sellerData = summaryResult.sellerSummary[sellerId];
                if (csvRows.length > 5) { csvRows.push([]); }
                
                csvRows.push([`--- สรุปยอดขาย: ${sellerData.sellerName} ---`]);
                csvRows.push(['ยอดขายรวม (บาท)', this.formatNumberSmart(sellerData.totalSales)]);
                csvRows.push(['ยอดเงินสด (บาท)', this.formatNumberSmart(sellerData.totalCash)]);
                csvRows.push(['ยอดเงินโอน (บาท)', this.formatNumberSmart(sellerData.totalTransfer)]);
                csvRows.push(['ยอดเครดิต (บาท)', this.formatNumberSmart(sellerData.totalCredit)]);
                if (!isSingleDayReport) {
                    csvRows.push(['จำนวนวันขายทั้งหมด (วัน)', summaryResult.totalSellingDays]);
                }

                if (isSellerReport) {
                    const sellerUser = this.data.users.find(u => u.id == sellerId);
                    let commission = 0;
                    let commissionLabel = 'คอมมิชชั่น (บาท)';
                    
                    if (sellerUser && sellerUser.commissionRate > 0) {
                        let commissionBase = 0;
                        let sources = [];
                        if (sellerUser.commissionOnCash) {
                            commissionBase += sellerData.totalCash;
                            sources.push('เงินสด');
                        }
                        if (sellerUser.commissionOnTransfer) {
                            commissionBase += sellerData.totalTransfer;
                            sources.push('เงินโอน');
                        }
                        if (sellerUser.commissionOnCredit) {
                            commissionBase += sellerData.totalCredit;
                            sources.push('เครดิต');
                        }
                        
                        commission = commissionBase * (sellerUser.commissionRate / 100);

                        if (sources.length > 0) {
                            commissionLabel = `คอมมิชชั่น (${sellerUser.commissionRate}% จาก ${sources.join('+')}) (บาท)`;
                        }
                    }
                    csvRows.push([commissionLabel, this.formatNumberSmart(commission)]);
                } else {
                    csvRows.push(['กำไรรวม (บาท)', this.formatNumberSmart(sellerData.totalProfit)]);
                }
                
                csvRows.push([]);
                csvRows.push(['สินค้า', 'ขาย(เงินสด)', 'ขาย(เงินโอน)', 'ขาย(เครดิต)', 'รวม(หน่วย)', 'ยอดขาย(บาท)', 'สต็อกคงเหลือ']);
                Object.values(sellerData.productSummary).forEach(p => {
                    const formattedStock = p.stock === 'N/A' ? 'N/A' : this.formatNumberSmart(p.stock);
                    csvRows.push([p.name, `${this.formatNumberSmart(p.cashQty)} ${p.unit}`, `${this.formatNumberSmart(p.transferQty)} ${p.unit}`, `${this.formatNumberSmart(p.creditQty)} ${p.unit}`, `${this.formatNumberSmart(p.totalQty)} ${p.unit}`, this.formatNumberSmart(p.totalValue), `${formattedStock} ${p.unit}`]);
                });
            }

            const csvContent = csvRows.map(row => row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')).join("\n");
            const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=utf-8;" });
            const fileName = `POS_Summary_${periodName}_${new Date().getTime()}.csv`;
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            link.click();
            URL.revokeObjectURL(link.href);
            this.showToast(`ส่งออกไฟล์ CSV '${fileName}' สำเร็จ`);
        },
        
        exportCreditSummaryToCsv(context) {
            const { creditData, periodName } = context;
            const { filteredCreditSales, sellerName, startDate, endDate } = creditData;
            let csvRows = [];
            
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear() + 543;
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const summaryDateTime = `${day}/${month}/${year} ${hours}:${minutes} น.`;
            
            const formatCurrency = (num) => this.formatNumberSmart(num);
            const formatDate = (dateStr) => this.formatThaiDateShortYear(dateStr);
            const periodString = `${formatDate(startDate)} ถึง ${formatDate(endDate)}`;

            csvRows.push(['สรุปโดย :', this.currentUser.username]);
            csvRows.push(['สรุปเมื่อ :', summaryDateTime]);
            csvRows.push([`สรุปรายการลูกหนี้ของ ${sellerName}:`, periodString]);
            csvRows.push([]);

            csvRows.push(['วันที่', 'ผู้ซื้อ', 'ผู้ขาย', 'รายการสินค้า', 'ยอดเงิน(บาท)', 'กำหนดชำระ']);
            
            let totalCredit = 0;
            [...filteredCreditSales].sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(s => {
                totalCredit += s.total;
                const itemsList = s.items.map(item => { 
                    const product = this.data.products.find(p => p.id === item.productId); 
                    const unit = product ? product.unit : 'หน่วย'; 
                    return `${item.name}(${this.formatNumberSmart(item.quantity)} ${unit})`; 
                }).join('; ');
                
                csvRows.push([
                    formatDate(s.date),
                    s.buyerName || '-',
                    s.sellerName || '-',
                    itemsList,
                    formatCurrency(s.total),
                    formatDate(s.creditDueDate)
                ]);
            });

            csvRows.push([]);
            csvRows.push(['', '', '', '', 'ยอดรวมลูกหนี้ทั้งหมด (บาท)', formatCurrency(totalCredit)]);

            const csvContent = csvRows.map(row => row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')).join("\n");
            const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=utf-8;" });
            const fileName = `Credit_Summary_${periodName}_${new Date().getTime()}.csv`;
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            link.click();
            URL.revokeObjectURL(link.href);
            this.showToast(`ส่งออกไฟล์ CSV '${fileName}' สำเร็จ`);
        },

        exportSalesHistoryToCsv() {
            const startDateStr = document.getElementById('export-sales-start-date').value;
            const endDateStr = document.getElementById('export-sales-end-date').value;

            if (!startDateStr || !endDateStr) {
                this.showToast('กรุณาเลือกวันที่เริ่มต้นและสิ้นสุด', 'warning');
                return;
            }

            const startDate = new Date(startDateStr);
            startDate.setHours(0, 0, 0, 0);

            const endDate = new Date(endDateStr);
            endDate.setHours(23, 59, 59, 999);

            if (startDate > endDate) {
                this.showToast('วันที่เริ่มต้นต้องมาก่อนวันที่สิ้นสุด', 'error');
                return;
            }

            const filteredSales = this.data.sales.filter(sale => {
                const saleDate = new Date(sale.date);
                return saleDate >= startDate && saleDate <= endDate;
            });

            if (filteredSales.length === 0) {
                this.showToast('ไม่พบรายการขายในช่วงวันที่ที่เลือก', 'info');
                return;
            }

            filteredSales.sort((a, b) => new Date(b.date) - new Date(a.date));

            let csvRows = [];
            csvRows.push(['วันที่', 'เวลา', 'รายการสินค้า', 'ราคาต่อหน่วย', 'จำนวน', 'ราคารวมต่อรายการ', 'ยอดขายรวม (บาท)', 'กำไรรวม (บาท)', 'ประเภทชำระ', 'รายละเอียดชำระ', 'กำหนดชำระ', 'ผู้ขาย', 'ร้านค้า']);

            filteredSales.forEach(sale => {
                const saleDate = new Date(sale.date);
                const dateString = this.formatThaiDateShortYear(sale.date);
                const timeString = `${String(saleDate.getHours()).padStart(2, '0')}:${String(saleDate.getMinutes()).padStart(2, '0')}`;
                
                let paymentDetail = '-';
                if (sale.paymentMethod === 'เครดิต') {
                    paymentDetail = sale.buyerName || '-';
                } else if (sale.paymentMethod === 'เงินโอน') {
                    paymentDetail = sale.transferorName || '-';
                }
                const dueDateString = this.formatThaiDateShortYear(sale.creditDueDate);

                sale.items.forEach((item, index) => {
                    const itemTotal = item.price * item.quantity;
                    const row = [
                        index === 0 ? dateString : '',
                        index === 0 ? timeString : '',
                        item.name + (item.isSpecialPrice ? ' (พิเศษ)' : ''),
                        this.formatNumberSmart(item.price),
                        this.formatNumberSmart(item.quantity),
                        this.formatNumberSmart(itemTotal),
                        index === 0 ? this.formatNumberSmart(sale.total) : '',
                        index === 0 ? this.formatNumberSmart(sale.profit) : '',
                        index === 0 ? (sale.paymentMethod || 'เงินสด') : '',
                        index === 0 ? paymentDetail : '',
                        index === 0 ? dueDateString : '',
                        index === 0 ? (sale.sellerName || '-') : '',
                        index === 0 ? (sale.storeName || '-') : ''
                    ];
                    csvRows.push(row);
                });
            });

            const csvContent = csvRows.map(row => row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')).join("\n");
            const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=utf-8;" });
            
            const fileName = `Sales_History_${startDateStr}_to_${endDateStr}.csv`;
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            link.click();
            URL.revokeObjectURL(link.href);
            this.showToast(`ส่งออกไฟล์ CSV '${fileName}' สำเร็จ`);
        },

        renderPos(payload = null) {
            this.editingSaleContext = null;
            const productSelect = document.getElementById('pos-product');
            if (!productSelect) return;
            
            let availableProducts = this.data.products;
            if (this.currentUser.role === 'seller') {
                const assignedIds = this.currentUser.assignedProductIds || [];
                availableProducts = availableProducts.filter(p => assignedIds.includes(p.id));
            }
            const productsInStock = availableProducts.filter(p => p.stock > 0);
            
            if (this.currentUser.role === 'seller' && productsInStock.length === 1) {
                const singleProduct = productsInStock[0];
                productSelect.innerHTML = `<option value="${singleProduct.id}">${singleProduct.name} (คงเหลือ: ${this.formatNumberSmart(singleProduct.stock)})</option>`;
                productSelect.disabled = true;
                productSelect.classList.add('single-product-seller');
            } else {
                productSelect.innerHTML = '<option value="">--- เลือกสินค้า ---</option>';
                productsInStock.forEach(p => {
                    productSelect.innerHTML += `<option value="${p.id}">${p.name} (คงเหลือ: ${this.formatNumberSmart(p.stock)})</option>`;
                });
                productSelect.disabled = false;
                productSelect.classList.remove('single-product-seller');
            }
            
            if (payload) { // For editing a sale
                this.editingSaleContext = { sellerId: payload.sellerId, sellerName: payload.sellerName };
                this.cart = [];
                payload.items.forEach(item => {
                    const product = this.data.products.find(p => p.id === item.productId);
                    if(product) {
                        const costAtTimeOfSale = (typeof item.cost === 'number' && !isNaN(item.cost)) ? item.cost : product.costPrice;
                        this.cart.push({ id: product.id, name: product.name, quantity: item.quantity, sellingPrice: item.price, costPrice: costAtTimeOfSale, isSpecialPrice: item.isSpecialPrice, originalPrice: item.originalPrice });
                    }
                });

                if (payload.paymentMethod === 'เครดิต') {
                    document.querySelector('input[name="payment-method"][value="เครดิต"]').checked = true;
                    document.getElementById('credit-buyer-name').value = payload.buyerName || '';
                    if (payload.creditDueDate && payload.date) {
                        const saleD = new Date(payload.date);
                        const dueD = new Date(payload.creditDueDate);
                        const timeDiff = dueD.getTime() - saleD.getTime();
                        const dayDiff = Math.round(timeDiff / (1000 * 3600 * 24));
                        document.getElementById('credit-due-days').value = dayDiff >= 0 ? dayDiff : '';
                    } else {
                        document.getElementById('credit-due-days').value = '';
                    }
                } else if (payload.paymentMethod === 'เงินโอน') {
                    document.querySelector('input[name="payment-method"][value="เงินโอน"]').checked = true;
                    document.getElementById('transfer-name').value = payload.transferorName || '';
                } else {
                    document.querySelector('input[name="payment-method"][value="เงินสด"]').checked = true;
                }
                
                document.getElementById('pos-date').value = payload.date.split('T')[0];
                const d = new Date(payload.date);
                document.getElementById('pos-time').value = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`
            } else {
                if (this.cart.length === 0) {
                    document.getElementById('pos-date').value = '';
                    document.getElementById('pos-time').value = '';
                    document.querySelector('input[name="payment-method"][value="เงินสด"]').checked = true;
                    document.getElementById('pos-date').classList.remove('backdating-active');
                    document.getElementById('pos-time').classList.remove('backdating-active');
                }
            }
            this.renderCart();
            this.togglePaymentDetailFields();
            this.updateSpecialPriceInfo();
        },

        renderCart() { const tbody = document.querySelector('#cart-table tbody'); if (!tbody) return; tbody.innerHTML = ''; let total = 0; this.cart.forEach((item, index) => { const tr = document.createElement('tr'); const itemTotal = item.sellingPrice * item.quantity; total += itemTotal; let itemName = item.name; if (item.isSpecialPrice) { itemName += ` <span style="font-weight:bold;">(พิเศษ)</span>`; } tr.innerHTML = `<td data-label="สินค้า">${itemName}</td><td data-label="ราคาฯ">${this.formatNumberSmart(item.sellingPrice)}</td><td data-label="จำนวน">${this.formatNumberSmart(item.quantity)}</td><td data-label="รวม">${this.formatNumberSmart(itemTotal)}</td><td data-label="ลบ"><div class="action-buttons"><button class="danger remove-from-cart-btn" data-index="${index}">ลบ</button></div></td>`; tbody.appendChild(tr); }); document.getElementById('cart-total').textContent = `฿${this.formatNumberSmart(total)}`; },
        
        addToCart(e) { 
            e.preventDefault(); 
            const productId = document.getElementById('pos-product').value; 
            if (!productId) { 
                this.showToast('กรุณาเลือกสินค้า'); 
                return; 
            } 
            const quantity = parseInt(document.getElementById('pos-quantity').value); 
            const product = this.data.products.find(p => p.id == productId); 
            if (quantity > product.stock) { 
                this.showToast('สินค้าในสต็อกไม่เพียงพอ'); 
                return; 
            } 
            const specialPriceInput = document.getElementById('special-price'); 
            let sellingPrice = product.sellingPrice; 
            let isSpecialPrice = false; 
            if (specialPriceInput.parentElement.parentElement.style.display !== 'none' && specialPriceInput.value.trim() !== '') { 
                const newPrice = parseFloat(specialPriceInput.value); 
                if (!isNaN(newPrice) && newPrice >= 0) { 
                    sellingPrice = newPrice; 
                    isSpecialPrice = true; 
                } 
            } 
            const existingCartItem = this.cart.find(item => item.id === product.id && item.sellingPrice === sellingPrice); 
            if (existingCartItem) { 
                existingCartItem.quantity += quantity; 
            } else { 
                this.cart.push({ id: product.id, name: product.name, quantity: quantity, sellingPrice: sellingPrice, costPrice: product.costPrice, isSpecialPrice: isSpecialPrice, originalPrice: product.sellingPrice }); 
            } 
            this.renderCart(); 
            const productSelect = document.getElementById('pos-product');
            if (!productSelect.disabled) {
                productSelect.value = '';
            }
            document.getElementById('pos-quantity').value = 1;
            document.getElementById('special-price').value = '';
            this.updateSpecialPriceInfo(); 
        },

        removeFromCart(index) { this.cart.splice(index, 1); this.renderCart(); },
        
        processSale() {
            if (this.cart.length === 0) {
                this.showToast('ตะกร้าว่างเปล่า');
                return;
            }
            try {
                const paymentMethod = document.querySelector('input[name="payment-method"]:checked').value;
                let buyerName = null, creditDueDateValue = null, transferorName = null;

                if (paymentMethod === 'เครดิต') {
                    const buyerNameInput = document.getElementById('credit-buyer-name');
                    buyerName = buyerNameInput.value.trim();
                    if (!buyerName) {
                        this.showToast('สำหรับรายการเครดิต กรุณาระบุชื่อผู้ซื้อ');
                        buyerNameInput.focus();
                        return;
                    }
                    const creditDaysInput = document.getElementById('credit-due-days').value;
                    const creditDays = parseInt(creditDaysInput);
                    if (!isNaN(creditDays) && creditDays >= 0) {
                        const dueDate = new Date(); 
                        dueDate.setDate(dueDate.getDate() + creditDays);
                        creditDueDateValue = dueDate.toISOString(); 
                    }
                } else if (paymentMethod === 'เงินโอน') {
                    const transferorNameInput = document.getElementById('transfer-name');
                    transferorName = transferorNameInput.value.trim();
                    if (!transferorName) {
                        this.showToast('สำหรับรายการเงินโอน กรุณาระบุชื่อผู้โอน');
                        transferorNameInput.focus();
                        return;
                    }
                }
                
                let saleDate = new Date();
                const dateInput = document.getElementById('pos-date').value;
                const timeInput = document.getElementById('pos-time').value;
                const isBackdatedSale = dateInput || timeInput;

                if (dateInput) {
                    const [year, month, day] = dateInput.split('-');
                    saleDate.setFullYear(parseInt(year), parseInt(month) - 1, parseInt(day));
                }
                if (timeInput) {
                    const [hours, minutes] = timeInput.split(':');
                    saleDate.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                }

                if (paymentMethod === 'เครดิต' && creditDueDateValue) {
                    const creditDays = parseInt(document.getElementById('credit-due-days').value);
                    if (!isNaN(creditDays) && creditDays >= 0) {
                        const dueDate = new Date(saleDate);
                        dueDate.setDate(dueDate.getDate() + creditDays);
                        creditDueDateValue = dueDate.toISOString();
                    }
                }
                
                let totalSale = 0, totalCost = 0;
                const saleItems = this.cart.map(item => {
                    const product = this.data.products.find(p => p.id === item.id);
                    if (product) {
                        if (item.quantity > product.stock) {
                            throw new Error(`สินค้าไม่พอ: ${product.name}`);
                        }
                        product.stock -= item.quantity;
                    }
                    totalSale += item.sellingPrice * item.quantity;
                    totalCost += item.costPrice * item.quantity;
                    return { productId: item.id, name: item.name, quantity: item.quantity, price: item.sellingPrice, cost: item.costPrice, isSpecialPrice: item.isSpecialPrice, originalPrice: item.originalPrice };
                });
                
                const sellerInfo = this.editingSaleContext ? { id: this.editingSaleContext.sellerId, name: this.editingSaleContext.sellerName } : { id: this.currentUser.id, name: this.currentUser.username };
                const store = this.data.stores.find(s => s.id === this.currentUser.storeId);

                const saleRecord = {
                    id: Date.now(),
                    date: saleDate.toISOString(),
                    items: saleItems,
                    total: totalSale,
                    profit: totalSale - totalCost,
                    paymentMethod,
                    buyerName: buyerName,
                    creditDueDate: creditDueDateValue,
                    transferorName: transferorName,
                    sellerId: sellerInfo.id,
                    sellerName: sellerInfo.name,
                    storeId: store ? store.id : null,
                    storeName: store ? store.name : null
                };
                
                this.data.sales.push(saleRecord);
                this.saveData();
                this.cart = [];
                this.editingSaleContext = null;
                
                if (isBackdatedSale) {
                    this.renderCart(); 
                    document.getElementById('pos-product').value = '';
                    document.getElementById('pos-quantity').value = 1;
                    document.getElementById('special-price').value = '';
                    this.updateSpecialPriceInfo();
                } else {
                    this.renderPos(); 
                }

                this.showToast('✓ บันทึกการขายสำเร็จ!');
            } catch(e) {
                this.showToast(e.message, 'error');
                console.error(e.message);
            }
        },

        renderSalesHistory() {
            const tbody = document.querySelector('#sales-history-table tbody');
            if (!tbody) return;
            tbody.innerHTML = '';
            [...this.data.sales].sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(sale => {
                const tr = document.createElement('tr');
                const saleDate = new Date(sale.date);
                const dateString = this.formatThaiDateShortYear(sale.date);
                const timeString = `${String(saleDate.getHours()).padStart(2,'0')}.${String(saleDate.getMinutes()).padStart(2,'0')} น.`;
                const itemsList = sale.items.map(item => {
                    let itemText = `${item.name} (x${this.formatNumberSmart(item.quantity)})`;
                    if (item.isSpecialPrice) {
                        itemText += ` <span style="color:red;">(พิเศษ ฿${this.formatNumberSmart(item.price)})</span>`;
                    }
                    return itemText;
                }).join('<br>');
                
                let paymentDisplay = sale.paymentMethod || '-';
                if (sale.paymentMethod === 'เครดิต' && sale.buyerName) {
                    paymentDisplay = `${sale.paymentMethod} (${sale.buyerName})`;
                } else if (sale.paymentMethod === 'เงินโอน' && sale.transferorName) {
                    paymentDisplay = `${sale.paymentMethod} (${sale.transferorName})`;
                }
                
                tr.innerHTML = `<td data-label="วันที่">${dateString}</td><td data-label="เวลา">${timeString}</td><td data-label="รายการสินค้า">${itemsList}</td><td data-label="ยอดขายรวม">${this.formatNumberSmart(sale.total)}</td><td data-label="กำไรรวม" style="color:${sale.profit >= 0 ? 'green' : 'red'};">${this.formatNumberSmart(sale.profit)}</td><td data-label="ประเภทชำระ">${paymentDisplay}</td><td data-label="คนขาย">${sale.sellerName}</td><td data-label="ร้านค้า">${sale.storeName || '-'}</td><td data-label="จัดการ"><div class="action-buttons"><button class="edit-sale-btn" data-id="${sale.id}" style="background-color: var(--warning-color);">แก้ไข</button><button class="danger delete-sale-btn" data-id="${sale.id}">ลบ</button></div></td>`;
                tbody.appendChild(tr);
            });
        },
        
        renderSellerSalesHistoryWithFilter() {
            const tbody = document.querySelector('#seller-sales-history-table tbody');
            if (!tbody || this.currentUser.role !== 'seller') return;

            const visibleDays = this.currentUser.visibleSalesDays;
            let adminCutoffDate = null;

            // 1. Determine the admin-defined boundary date
            if (typeof visibleDays === 'number' && visibleDays >= 0) {
                adminCutoffDate = new Date();
                adminCutoffDate.setDate(adminCutoffDate.getDate() - visibleDays);
                adminCutoffDate.setHours(0, 0, 0, 0);
            }

            // 2. Get the seller's filter choice
            const filterType = document.querySelector('input[name="seller-filter-type"]:checked').value;
            let filterStartDate = new Date();
            let filterEndDate = new Date();

            switch (filterType) {
                case 'today':
                    filterStartDate.setHours(0, 0, 0, 0);
                    filterEndDate.setHours(23, 59, 59, 999);
                    break;
                case 'by_date':
                    const selectedDateStr = document.getElementById('seller-filter-date').value;
                    if (!selectedDateStr) {
                        this.showToast('กรุณาเลือกวันที่', 'warning');
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">กรุณาเลือกวันที่ที่ต้องการค้นหา</td></tr>';
                        return;
                    }
                    filterStartDate = new Date(selectedDateStr);
                    filterStartDate.setHours(0, 0, 0, 0);
                    filterEndDate = new Date(selectedDateStr);
                    filterEndDate.setHours(23, 59, 59, 999);
                    break;
                case 'by_range':
                    const startDateStr = document.getElementById('seller-filter-start-date').value;
                    const endDateStr = document.getElementById('seller-filter-end-date').value;
                    if (!startDateStr || !endDateStr) {
                        this.showToast('กรุณาเลือกวันที่เริ่มต้นและสิ้นสุด', 'warning');
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">กรุณาเลือกช่วงวันที่ที่ต้องการค้นหา</td></tr>';
                        return;
                    }
                    filterStartDate = new Date(startDateStr);
                    filterStartDate.setHours(0, 0, 0, 0);
                    filterEndDate = new Date(endDateStr);
                    filterEndDate.setHours(23, 59, 59, 999);
                    break;
            }

            // 3. Validate seller's filter against admin's boundary
            if (adminCutoffDate && filterStartDate < adminCutoffDate) {
                this.showToast(`คุณสามารถดูประวัติได้ไม่เกินวันที่ ${this.formatThaiDateFullYear(adminCutoffDate)}`, 'error');
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red;">อยู่นอกช่วงเวลาที่ได้รับอนุญาต</td></tr>`;
                return;
            }
            
            // 4. Filter the sales data
            const mySales = this.data.sales.filter(sale => {
                if (sale.sellerId !== this.currentUser.id) return false;
                const saleDate = new Date(sale.date);
                return saleDate >= filterStartDate && saleDate <= filterEndDate;
            });

            // 5. Render the results
            tbody.innerHTML = '';
            if (mySales.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">ไม่พบรายการขายในช่วงที่เลือก</td></tr>';
                 return;
            }

            mySales.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(sale => {
                const tr = document.createElement('tr');
                const saleDate = new Date(sale.date);
                const dateString = this.formatThaiDateShortYear(sale.date);
                const timeString = `${String(saleDate.getHours()).padStart(2, '0')}.${String(saleDate.getMinutes()).padStart(2, '0')} น.`;
                const itemsList = sale.items.map(item => `${item.name} (x${this.formatNumberSmart(item.quantity)})`).join('<br>');
                let paymentDisplay = sale.paymentMethod || '-';
                if (sale.paymentMethod === 'เครดิต' && sale.buyerName) {
                    paymentDisplay = `${sale.paymentMethod} (${sale.buyerName})`;
                } else if (sale.paymentMethod === 'เงินโอน' && sale.transferorName) {
                    paymentDisplay = `${sale.paymentMethod} (${sale.transferorName})`;
                }
                tr.innerHTML = `
                    <td data-label="วันที่">${dateString}</td>
                    <td data-label="เวลา">${timeString}</td>
                    <td data-label="รายการสินค้า">${itemsList}</td>
                    <td data-label="ยอดขาย">${this.formatNumberSmart(sale.total)}</td>
                    <td data-label="ประเภทชำระ">${paymentDisplay}</td>
                    <td data-label="จัดการ"><div class="action-buttons"><button class="danger seller-delete-sale-btn" data-id="${sale.id}">ลบ</button></div></td>`;
                tbody.appendChild(tr);
            });
        },

        editSale(saleId) { const confirmation = confirm("การแก้ไขจะทำการ **ยกเลิก** รายการขายเดิม และนำสินค้าทั้งหมดกลับเข้าตะกร้าเพื่อให้คุณทำรายการใหม่\n\nคุณต้องการดำเนินการต่อหรือไม่?"); if (!confirmation) return; const saleToEdit = this.deleteSale(saleId, true); if (!saleToEdit) return; this.showToast('รายการถูกนำกลับเข้าตะกร้าแล้ว กรุณาแก้ไขและยืนยันการขายอีกครั้ง'); this.showPage('page-pos', saleToEdit); },
        deleteSale(saleId, isEditing = false) { 
            const saleIndex = this.data.sales.findIndex(s => s.id == saleId); 
            if (saleIndex === -1) { 
                this.showToast('ไม่พบรายการขาย'); 
                return null; 
            } 
            if (!isEditing) { 
                if (!confirm('คุณแน่ใจหรือไม่ว่าต้องการลบรายการขายนี้? สต็อกสินค้าจะถูกคืนเข้าระบบ')) return null; 
            } 
            const [saleToDelete] = this.data.sales.splice(saleIndex, 1); 
            saleToDelete.items.forEach(item => { 
                const product = this.data.products.find(p => p.id === item.productId); 
                if (product) { 
                    product.stock += item.quantity; 
                } 
            }); 
            this.saveData(); 
            if (!isEditing) { 
                this.showToast('ลบรายการขายและคืนสต็อกเรียบร้อย'); 
            } 
            return saleToDelete; 
        },
        
        togglePaymentDetailFields() {
            const creditFieldsContainer = document.getElementById('credit-fields-container');
            const transferFieldsContainer = document.getElementById('transfer-fields-container');
            const paymentMethod = document.querySelector('input[name="payment-method"]:checked').value;

            if (paymentMethod === 'เครดิต') {
                creditFieldsContainer.style.display = 'block';
                transferFieldsContainer.style.display = 'none';
                document.getElementById('transfer-name').value = '';
            } else if (paymentMethod === 'เงินโอน') {
                transferFieldsContainer.style.display = 'block';
                creditFieldsContainer.style.display = 'none';
                document.getElementById('credit-buyer-name').value = '';
                document.getElementById('credit-due-days').value = '';
            } else { // เงินสด
                creditFieldsContainer.style.display = 'none';
                transferFieldsContainer.style.display = 'none';
                document.getElementById('credit-buyer-name').value = '';
                document.getElementById('credit-due-days').value = '';
                document.getElementById('transfer-name').value = '';
            }
        },

        toggleSpecialPrice() { const container = document.getElementById('special-price-container'); const input = document.getElementById('special-price'); if (container.style.display === 'none') { container.style.display = 'grid'; input.focus(); } else { container.style.display = 'none'; input.value = ''; } },
        updateSpecialPriceInfo() { const productId = document.getElementById('pos-product').value; const infoSpan = document.getElementById('current-price-info'); if (infoSpan) { if (productId) { const product = this.data.products.find(p => p.id == productId); infoSpan.textContent = `ราคาปกติ: ${this.formatNumberSmart(product.sellingPrice)} บาท`; } else { infoSpan.textContent = ''; } } },
        manualSaveToBrowser() { try { this.saveData(); this.showToast('✓ บันทึกข้อมูลลงในเบราว์เซอร์แล้ว'); } catch (error) { console.error("บันทึกข้อมูลไม่สำเร็จ:", error); this.showToast("⚠️ เกิดข้อผิดพลาดในการบันทึกข้อมูล", "error"); } },
        
        saveBackupToFile() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const dateTimeString = `${year}${month}${day}_${hours}${minutes}`;
            const sellerUsername = this.currentUser.username;
            const fullFileName = `pos_backup_${sellerUsername}_${dateTimeString}.json`;

            const dataToSave = this.data;
            const blob = new Blob([JSON.stringify(dataToSave, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = fullFileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            this.showToast(`บันทึกไฟล์ "${fullFileName}" เรียบร้อย`);
        },

        recalculateAllStock() {
            const totalStockIn = new Map();
            const totalSold = new Map();
            const totalStockOut = new Map();

            this.data.stockIns.forEach(si => {
                const currentQty = totalStockIn.get(si.productId) || 0;
                totalStockIn.set(si.productId, currentQty + si.quantity);
            });

            this.data.sales.forEach(sale => {
                sale.items.forEach(item => {
                    const currentQty = totalSold.get(item.productId) || 0;
                    totalSold.set(item.productId, currentQty + item.quantity);
                });
            });

            this.data.stockOuts.forEach(so => {
                const currentQty = totalStockOut.get(so.productId) || 0;
                totalStockOut.set(so.productId, currentQty + so.quantity);
            });

            this.data.products.forEach(product => {
                const initialStock = totalStockIn.get(product.id) || 0;
                const soldQty = totalSold.get(product.id) || 0;
                const stockOutQty = totalStockOut.get(product.id) || 0;
                product.stock = initialStock - soldQty - stockOutQty;
            });
            console.log("Stock recalculated for all products based on history.");
        },
        
        _mergeSingleArray(currentArray, newArray, key = 'id') {
            if (!newArray || !Array.isArray(newArray)) return;
            const currentIds = new Set(currentArray.map(item => item[key]));
            
            newArray.forEach(newItem => {
                if (!newItem || typeof newItem[key] === 'undefined') return;

                if (currentIds.has(newItem[key])) {
                    const index = currentArray.findIndex(currentItem => currentItem[key] === newItem[key]);
                    if (index > -1) {
                        currentArray[index] = newItem;
                    }
                } else {
                    currentArray.push(newItem);
                    currentIds.add(newItem[key]);
                }
            });
        },
        
        mergeData(dataFromFile) {
            if (dataFromFile.users && Array.isArray(dataFromFile.users)) {
                const currentAdmin = this.data.users.find(u => u.username === 'admin');
                const importedAdmin = dataFromFile.users.find(u => u.username === 'admin');
                if (currentAdmin && importedAdmin) {
                    currentAdmin.password = importedAdmin.password;
                }
                const importedSellers = dataFromFile.users.filter(u => u.role !== 'admin');
                this._mergeSingleArray(this.data.users, importedSellers, 'id');
            }

            this._mergeSingleArray(this.data.stores, dataFromFile.stores, 'id');
            this._mergeSingleArray(this.data.sales, dataFromFile.sales, 'id');
            this._mergeSingleArray(this.data.stockIns, dataFromFile.stockIns, 'id');
            this._mergeSingleArray(this.data.stockOuts, dataFromFile.stockOuts, 'id');
            
            if (dataFromFile.products && Array.isArray(dataFromFile.products)) {
                dataFromFile.products.forEach(newProduct => {
                    if (!newProduct || typeof newProduct.id === 'undefined') return;
                    const existingProduct = this.data.products.find(p => p.id === newProduct.id);
                    if (existingProduct) {
                        existingProduct.name = newProduct.name;
                        existingProduct.costPrice = newProduct.costPrice;
                        existingProduct.sellingPrice = newProduct.sellingPrice;
                        existingProduct.unit = newProduct.unit;
                    } else {
                        this.data.products.push(newProduct);
                    }
                });
            }
        },

        promptLoadFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const content = e.target.result;
                    const importedData = JSON.parse(content);

                    if (importedData && typeof importedData === 'object' && 'users' in importedData && 'products' in importedData && 'sales' in importedData) {
                        const confirmationMessage = "คุณต้องการรวมข้อมูลจากไฟล์นี้เข้ากับข้อมูลปัจจุบันหรือไม่?\n\n- ข้อมูลที่ซ้ำกันจะถูกทับด้วยข้อมูลจากไฟล์\n- ข้อมูลใหม่จะถูกเพิ่มเข้ามา\n- **สต็อกสินค้าจะถูกคำนวณใหม่ทั้งหมด** จากประวัติการนำเข้าและประวัติการขายเพื่อให้ถูกต้องที่สุด\n\nยืนยันเพื่อดำเนินการต่อ?";
                        
                        if (confirm(confirmationMessage)) {
                            this.mergeData(importedData);
                            this.recalculateAllStock();
                            this.saveData();
                            this.showToast('รวมข้อมูลและคำนวณสต็อกใหม่สำเร็จ! กำลังรีโหลด...', 'success');
                            setTimeout(() => location.reload(), 2000);
                        }
                    } else {
                        throw new Error("ไฟล์ไม่มีโครงสร้างข้อมูลที่ถูกต้อง");
                    }
                } catch (error) {
                    this.showToast("เกิดข้อผิดพลาด: " + error.message, "error");
                } finally {
                    event.target.value = '';
                }
            };
            reader.onerror = () => this.showToast("ไม่สามารถอ่านไฟล์ได้", "error");
            reader.readAsText(file, 'UTF-8');
        },

        openResetModal() {
            document.getElementById('reset-sales-checkbox').checked = false;
            document.getElementById('reset-stockins-checkbox').checked = false;
            document.getElementById('reset-products-checkbox').checked = false;
            document.getElementById('reset-sellers-checkbox').checked = false;
            document.getElementById('reset-stores-checkbox').checked = false;
            document.getElementById('resetModal').style.display = 'flex';
        },
        closeResetModal() { document.getElementById('resetModal').style.display = 'none'; },
        handleSelectiveReset() {
            const resetSales = document.getElementById('reset-sales-checkbox').checked;
            const resetStockIns = document.getElementById('reset-stockins-checkbox').checked;
            const resetProducts = document.getElementById('reset-products-checkbox').checked;
            const resetSellers = document.getElementById('reset-sellers-checkbox').checked;
            const resetStores = document.getElementById('reset-stores-checkbox').checked;

            if (!resetSales && !resetStockIns && !resetProducts && !resetSellers && !resetStores) {
                this.showToast('กรุณาเลือกอย่างน้อยหนึ่งรายการที่จะรีเซ็ต', 'warning');
                return;
            }
            let confirmationMessage = "คุณกำลังจะลบข้อมูลต่อไปนี้อย่างถาวร:\n";
            if(resetSales) confirmationMessage += "\n- ประวัติการขายทั้งหมด";
            if(resetStockIns) confirmationMessage += "\n- ประวัติการนำเข้าและปรับออกทั้งหมด";
            if(resetProducts) confirmationMessage += "\n- สินค้าทั้งหมด";
            if(resetSellers) confirmationMessage += "\n- ผู้ขายทั้งหมด (ยกเว้น Admin)";
            if(resetStores) confirmationMessage += "\n- ร้านค้าทั้งหมด";
            confirmationMessage += "\n\nการกระทำนี้ไม่สามารถย้อนกลับได้! พิมพ์ '5555' เพื่อยืนยัน:";
            const userConfirmation = prompt(confirmationMessage);

            if (userConfirmation === '5555') {
                if (resetSales) { this.data.sales = []; }
                if (resetStockIns) { this.data.stockIns = []; this.data.stockOuts = []; }
                if (resetProducts) { this.data.products = []; }
                if (resetSellers) { this.data.users = this.data.users.filter(u => u.role !== 'seller'); }
                if (resetStores) { this.data.stores = []; }
                
                this.saveData();
                this.closeResetModal();
                this.showToast('ข้อมูลที่เลือกถูกรีเซ็ตเรียบร้อยแล้ว! กำลังรีโหลด...', 'success');
                setTimeout(() => { location.reload(); }, 2000);
            } else {
                this.showToast('การรีเซ็ตถูกยกเลิก', 'warning');
            }
        },
        
        renderStockSummaryReport() {
            const container = document.getElementById('stock-summary-report-container');
            if (!container) return;

            let tableHTML = `<div class="table-container"><table id="stock-summary-table">
                <thead>
                    <tr>
                        <th>สินค้า</th>
                        <th>นำเข้าทั้งหมด</th>
                        <th>ขายไปทั้งหมด</th>
                        <th>ปรับออก</th>
                        <th>สต็อก (คำนวณ)</th>
                        <th>สต็อก (ปัจจุบัน)</th>
                        <th>สถานะ</th>
                    </tr>
                </thead>
                <tbody>`;
            
            let hasDiscrepancy = false;

            this.data.products.forEach(product => {
                const totalStockIn = this.data.stockIns
                    .filter(si => si.productId === product.id)
                    .reduce((sum, si) => sum + si.quantity, 0);
                
                const totalSold = this.data.sales
                    .flatMap(sale => sale.items)
                    .filter(item => item.productId === product.id)
                    .reduce((sum, item) => sum + item.quantity, 0);

                const totalStockOut = this.data.stockOuts
                    .filter(so => so.productId === product.id)
                    .reduce((sum, so) => sum + so.quantity, 0);

                const calculatedStock = totalStockIn - totalSold - totalStockOut;
                const currentStock = product.stock;
                
                const isMatch = (calculatedStock === currentStock);
                if (!isMatch) { hasDiscrepancy = true; }

                tableHTML += `
                    <tr style="${!isMatch ? 'background-color: #ffdddd; color: var(--danger-color); font-weight: bold;' : ''}">
                        <td data-label="สินค้า">${product.name}</td>
                        <td data-label="นำเข้าทั้งหมด">${this.formatNumberSmart(totalStockIn)} ${product.unit}</td>
                        <td data-label="ขายไปทั้งหมด">${this.formatNumberSmart(totalSold)} ${product.unit}</td>
                        <td data-label="ปรับออก">${this.formatNumberSmart(totalStockOut)} ${product.unit}</td>
                        <td data-label="สต็อก (คำนวณ)">${this.formatNumberSmart(calculatedStock)} ${product.unit}</td>
                        <td data-label="สต็อก (ปัจจุบัน)">${this.formatNumberSmart(currentStock)} ${product.unit}</td>
                        <td data-label="สถานะ">${isMatch ? '<span style="color:green;">✓ ตรงกัน</span>' : '✗ ไม่ตรงกัน'}</td>
                    </tr>
                `;
            });

            tableHTML += `</tbody></table></div>`;
            
            let summaryText = hasDiscrepancy 
                ? `<p style="color: var(--danger-color); text-align: center; font-weight: bold;">ตรวจพบสต็อกไม่ตรงกัน! คุณสามารถกดปุ่ม "คำนวณสต็อกใหม่ทั้งหมด" เพื่อแก้ไข</p>`
                : `<p style="color: var(--success-color); text-align: center; font-weight: bold;">ยอดสต็อกทั้งหมดถูกต้อง</p>`;

            container.innerHTML = summaryText + tableHTML;
            this.showToast('สร้างรายงานสต็อกสำเร็จ');
        },

        handleRecalculateStock() {
            if (confirm("คุณต้องการคำนวณสต็อกของสินค้าทุกรายการใหม่จากประวัติทั้งหมดหรือไม่?\n\n(นำเข้า - ขาย - ปรับออก)\n\nการกระทำนี้จะเขียนทับค่าสต็อกปัจจุบันของสินค้าทุกชิ้น")) {
                this.recalculateAllStock();
                this.saveData();
                this.showToast('คำนวณและบันทึกสต็อกใหม่เรียบร้อยแล้ว!', 'success');
                if(document.getElementById('admin-stock-report-content').classList.contains('active')) {
                    this.renderStockSummaryReport();
                }
            }
        },

        renderProductTable() { const tbody = document.querySelector('#product-table tbody'); if (!tbody) return; tbody.innerHTML = ''; this.data.products.forEach(p => { const tr = document.createElement('tr'); tr.innerHTML = `<td data-label="ชื่อสินค้า">${p.name}</td><td data-label="ราคาทุน">${this.formatNumberSmart(p.costPrice)}</td><td data-label="ราคาขาย">${this.formatNumberSmart(p.sellingPrice)}</td><td data-label="สต็อก">${this.formatNumberSmart(p.stock)}</td><td data-label="หน่วย">${p.unit}</td><td data-label="จัดการ"><div class="action-buttons"><button class="edit-product-btn" data-id="${p.id}" style="background-color: var(--warning-color);">แก้ไข</button><button class="danger delete-product-btn" data-id="${p.id}">ลบ</button></div></td>`; tbody.appendChild(tr); }); },
        
        saveProduct(e) {
            e.preventDefault();
            const idValue = document.getElementById('product-id').value;
            const id = idValue ? parseInt(idValue, 10) : null;

            const newProductData = {
                name: document.getElementById('product-name').value,
                costPrice: parseFloat(document.getElementById('product-cost').value),
                sellingPrice: parseFloat(document.getElementById('product-price').value),
                unit: document.getElementById('product-unit').value
            };

            if (id) {
                const index = this.data.products.findIndex(p => p.id === id); 
                if (index > -1) {
                    const oldProduct = this.data.products[index];
                    const newName = newProductData.name;
                    if (oldProduct.name !== newName) {
                        this.data.sales.forEach(sale => {
                            sale.items.forEach(item => {
                                if (item.productId === id) { item.name = newName; }
                            });
                        });
                        this.data.stockIns.forEach(stockIn => {
                            if (stockIn.productId === id) { stockIn.productName = newName; }
                        });
                        this.data.stockOuts.forEach(stockOut => {
                            if (stockOut.productId === id) { stockOut.productName = newName; }
                        });
                        this.showToast('อัปเดตชื่อสินค้าในประวัติย้อนหลังเรียบร้อย');
                    }
                    this.data.products[index] = { ...this.data.products[index], ...newProductData };
                }
            } else {
                newProductData.id = Date.now();
                newProductData.stock = 0;
                this.data.products.push(newProductData);
            }
            this.saveData();
            this.renderProductTable();
            document.getElementById('product-form').reset();
            document.getElementById('product-id').value = '';
        },
        editProduct(id) { const product = this.data.products.find(p => p.id == id); if(product) { document.getElementById('product-id').value = product.id; document.getElementById('product-name').value = product.name; document.getElementById('product-cost').value = product.costPrice; document.getElementById('product-price').value = product.sellingPrice; document.getElementById('product-unit').value = product.unit; document.getElementById('product-name').focus(); } },
        deleteProduct(id) { if(confirm('คุณแน่ใจหรือไม่ว่าต้องการลบสินค้านี้? การกระทำนี้จะลบสินค้าออกจากระบบ แต่จะไม่ลบประวัติการขายหรือการนำเข้าที่เกี่ยวข้อง')) { this.data.products = this.data.products.filter(p => p.id != id); this.saveData(); this.renderProductTable(); } },
        
        renderStockIn() { 
            const productSelect = document.getElementById('stock-in-product'); 
            productSelect.innerHTML = '<option value="">--- เลือกสินค้า ---</option>'; 
            this.data.products.forEach(p => { productSelect.innerHTML += `<option value="${p.id}">${p.name}</option>`; }); 
            const historyTbody = document.querySelector('#stock-in-history-table tbody'); 
            historyTbody.innerHTML = ''; 
            [...this.data.stockIns].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 20).forEach(si => { 
                const tr = document.createElement('tr'); 
                const stockInDate = new Date(si.date);
                const dateString = this.formatThaiDateShortYear(si.date);
                const timeString = `${String(stockInDate.getHours()).padStart(2, '0')}.${String(stockInDate.getMinutes()).padStart(2, '0')} น.`;
                tr.innerHTML = `<td data-label="วันที่">${dateString}</td>
                                <td data-label="เวลา">${timeString}</td>
                                <td data-label="สินค้า">${si.productName}</td>
                                <td data-label="จำนวน">${this.formatNumberSmart(si.quantity)}</td>
                                <td data-label="ทุนต่อหน่วย">${this.formatNumberSmart(si.costPerUnit)}</td>
                                <td data-label="ยอดรวม">${this.formatNumberSmart(si.quantity * si.costPerUnit)}</td>`; 
                historyTbody.appendChild(tr); 
            }); 
        },
        saveStockIn(e) { e.preventDefault(); const productId = document.getElementById('stock-in-product').value; const quantity = parseInt(document.getElementById('stock-in-quantity').value); const costPerUnit = parseFloat(document.getElementById('stock-in-cost').value); const product = this.data.products.find(p => p.id == productId); if (product) { product.stock += quantity; const stockInRecord = { id: Date.now(), date: new Date().toISOString(), productId: product.id, productName: product.name, quantity, costPerUnit }; this.data.stockIns.push(stockInRecord); this.saveData(); this.showToast('บันทึกการนำเข้าเรียบร้อย'); document.getElementById('stock-in-form').reset(); this.renderStockIn(); } else { this.showToast('ไม่พบสินค้า'); } },
        
        renderStockOut() { 
            const productSelect = document.getElementById('stock-out-product'); 
            productSelect.innerHTML = '<option value="">--- เลือกสินค้า ---</option>'; 
            this.data.products.forEach(p => { productSelect.innerHTML += `<option value="${p.id}">${p.name} (คงเหลือ: ${this.formatNumberSmart(p.stock)})</option>`; }); 
            const historyTbody = document.querySelector('#stock-out-history-table tbody'); 
            historyTbody.innerHTML = ''; 
            [...this.data.stockOuts].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 20).forEach(so => { 
                const tr = document.createElement('tr'); 
                const stockOutDate = new Date(so.date);
                const dateString = this.formatThaiDateShortYear(so.date);
                const timeString = `${String(stockOutDate.getHours()).padStart(2, '0')}.${String(stockOutDate.getMinutes()).padStart(2, '0')} น.`;
                tr.innerHTML = `<td data-label="วันที่">${dateString}</td>
                                <td data-label="เวลา">${timeString}</td>
                                <td data-label="สินค้า">${so.productName}</td>
                                <td data-label="จำนวน">${this.formatNumberSmart(so.quantity)}</td>
                                <td data-label="เหตุผล">${so.reason}</td>`; 
                historyTbody.appendChild(tr); 
            }); 
        },
        saveStockOut(e) { 
            e.preventDefault(); 
            const productId = document.getElementById('stock-out-product').value; 
            const quantity = parseInt(document.getElementById('stock-out-quantity').value); 
            const reason = document.getElementById('stock-out-reason').value.trim();
            const product = this.data.products.find(p => p.id == productId); 

            if (!product) {
                this.showToast('ไม่พบสินค้า', 'error');
                return;
            }
            if (isNaN(quantity) || quantity <= 0) {
                this.showToast('กรุณากรอกจำนวนให้ถูกต้อง', 'error');
                return;
            }
            if (!reason) {
                this.showToast('กรุณาระบุเหตุผลในการนำออก', 'error');
                return;
            }
            if (quantity > product.stock) {
                this.showToast('สินค้าในสต็อกไม่เพียงพอที่จะนำออก', 'error');
                return;
            }

            product.stock -= quantity; 
            const stockOutRecord = { 
                id: Date.now(), 
                date: new Date().toISOString(), 
                productId: product.id, 
                productName: product.name, 
                quantity, 
                reason 
            }; 
            this.data.stockOuts.push(stockOutRecord); 
            this.saveData(); 
            this.showToast('บันทึกการนำออกสินค้าเรียบร้อย'); 
            document.getElementById('stock-out-form').reset(); 
            this.renderStockOut(); 
        },

        renderReport(e) {
            const sellerSelect = document.getElementById('report-seller');
            const previouslySelectedSeller = sellerSelect.value; 

            sellerSelect.innerHTML = '<option value="all">ทั้งหมด</option>';
            this.data.users.forEach(u => {
                sellerSelect.innerHTML += `<option value="${u.id}">${u.username}</option>`;
            });
            
            sellerSelect.value = previouslySelectedSeller || 'all'; 

            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;
            const sellerId = document.getElementById('report-seller').value; 
            let filteredSales = this.data.sales;
            if (startDate) filteredSales = filteredSales.filter(s => s.date >= new Date(startDate).toISOString());
            if (endDate) {
                const endOfDay = new Date(endDate);
                endOfDay.setHours(23, 59, 59, 999);
                filteredSales = filteredSales.filter(s => s.date <= endOfDay.toISOString());
            }
            if (sellerId !== 'all') filteredSales = filteredSales.filter(s => s.sellerId == sellerId);
            const totalSales = filteredSales.reduce((sum, s) => sum + s.total, 0);
            const totalProfit = filteredSales.reduce((sum, s) => sum + s.profit, 0);
            const totalCost = totalSales - totalProfit;
            document.getElementById('report-total-sales').textContent = `฿${this.formatNumberSmart(totalSales)}`;
            document.getElementById('report-total-cost').textContent = `฿${this.formatNumberSmart(totalCost)}`;
            document.getElementById('report-net-profit').textContent = `฿${this.formatNumberSmart(totalProfit)}`;
            document.getElementById('report-net-profit').style.color = totalProfit >= 0 ? 'var(--success-color)' : 'var(--danger-color)';
        },

        renderStoreTable() { const tbody = document.querySelector('#store-table tbody'); tbody.innerHTML = ''; this.data.stores.forEach(s => { const tr = document.createElement('tr'); tr.innerHTML = `<td data-label="ชื่อร้านค้า">${s.name}</td> <td data-label="จัดการ"><div class="action-buttons"><button class="edit-store-btn" data-id="${s.id}" style="background-color: var(--warning-color);">แก้ไข</button><button class="danger delete-store-btn" data-id="${s.id}">ลบ</button></div></td>`; tbody.appendChild(tr); }); },
        
        saveStore(e) {
            e.preventDefault();
            const id = document.getElementById('store-id').value;
            const name = document.getElementById('store-name').value.trim();
            
            if (!name) {
                this.showToast('กรุณากรอกชื่อร้าน', 'error');
                return;
            }

            if (id) { 
                const storeId = parseInt(id, 10);
                const storeIndex = this.data.stores.findIndex(s => s.id === storeId);
                
                if (storeIndex > -1) {
                    const oldStore = this.data.stores[storeIndex];
                    if (oldStore.name !== name) {
                        this.data.sales.forEach(sale => {
                            if (sale.storeId === storeId) {
                                sale.storeName = name;
                            }
                        });
                        this.showToast('อัปเดตชื่อร้านในประวัติการขายเรียบร้อย');
                    }
                    this.data.stores[storeIndex].name = name;
                    this.showToast('แก้ไขชื่อร้านสำเร็จ', 'success'); 
                }
            } else { 
                this.data.stores.push({ id: Date.now(), name });
                this.showToast('เพิ่มร้านใหม่สำเร็จ');
            }
            
            this.saveData();
            this.renderStoreTable();
            document.getElementById('store-form').reset();
            document.getElementById('store-id').value = '';
        },
        
        editStore(id) { const store = this.data.stores.find(s => s.id == id); if (store) { document.getElementById('store-id').value = store.id; document.getElementById('store-name').value = store.name; document.getElementById('store-name').focus(); } },
        deleteStore(id) { const isStoreInUse = this.data.users.some(u => u.storeId == id); if (isStoreInUse) { this.showToast('ไม่สามารถลบร้านค้านี้ได้ เนื่องจากมีผู้ใช้สังกัดอยู่', 'error'); return; } if (confirm('คุณแน่ใจหรือไม่ว่าต้องการลบร้านค้านี้?')) { this.data.stores = this.data.stores.filter(s => s.id != id); this.saveData(); this.renderStoreTable(); this.showToast('ลบร้านค้าเรียบร้อย'); } },
        
        renderUserTable() {
            const tbody = document.querySelector('#user-table tbody');
            if (!tbody) return; 
            tbody.innerHTML = '';
            this.data.users.forEach(u => {
                let assignedText = 'N/A';
                if (u.role === 'seller') {
                    const assignedIds = u.assignedProductIds || [];
                    if (this.data.products.length > 0 && assignedIds.length === this.data.products.length) assignedText = 'ทั้งหมด';
                    else if (assignedIds.length > 0) assignedText = `${assignedIds.length} รายการ`;
                    else assignedText = 'ยังไม่กำหนด';
                }
                let salesPeriodText = 'N/A';
                if (u.role === 'seller') {
                    const formatDate = (dateStr) => this.formatThaiDateShortYear(dateStr);
                    const start = formatDate(u.salesStartDate);
                    const end = formatDate(u.salesEndDate);
                    if (start !== '-' || end !== '-') {
                        salesPeriodText = `${start !== '-' ? start : 'ไม่กำหนด'} - ${end !== '-' ? end : 'ไม่กำหนด'}`;
                    } else {
                        salesPeriodText = 'ไม่กำหนด';
                    }
                }
                const store = this.data.stores.find(s => s.id === u.storeId);
                const storeName = store ? store.name : 'ยังไม่กำหนด';
                const tr = document.createElement('tr');
                tr.innerHTML = `<td data-label="ชื่อผู้ใช้">${u.username}</td><td data-label="ประเภท">${u.role}</td><td data-label="ร้านค้า">${storeName}</td><td data-label="สินค้าที่ขายได้">${assignedText}</td><td data-label="ระยะเวลาที่ขายได้">${salesPeriodText}</td> <td data-label="จัดการ"><div class="action-buttons"><button class="edit-user-btn" data-id="${u.id}" style="background-color: var(--warning-color);">แก้ไข</button> ${u.username !== 'admin' ? `<button class="danger delete-user-btn" data-id="${u.id}">ลบ</button>` : ''}</div></td>`;
                tbody.appendChild(tr);
            });
            
            this.setupUserForm(); 
        },

        saveUser(e) {
            e.preventDefault();

            const id = document.getElementById('user-id').value;
            const username = document.getElementById('user-username').value;
            const password = document.getElementById('user-password').value;
            const role = document.getElementById('user-role').value;
            const startDate = document.getElementById('user-sales-start-date').value;
            const endDate = document.getElementById('user-sales-end-date').value;

            if (!username.trim()) {
                this.showToast('กรุณากรอกชื่อผู้ใช้', 'error');
                return;
            }

            let assignedProductIds = [];
            let storeId = null;
            let commissionRate = 0, commissionOnCash = false, commissionOnTransfer = false, commissionOnCredit = false;
            let visibleSalesDays = null; // NEW: Initialize variable

            if (role === 'seller') {
                const storeSelect = document.getElementById('user-store-select');
                storeId = storeSelect ? storeSelect.value : null;

                if (!storeId) {
                    this.showToast('กรุณาระบุร้านค้าสำหรับผู้ขาย', 'error');
                    return;
                }
                storeId = parseInt(storeId, 10); 

                if (!startDate || !endDate) {
                    this.showToast('กรุณากำหนดระยะเวลาการขายให้ครบถ้วน', 'error');
                    return;
                }
                if (new Date(startDate) > new Date(endDate)) {
                    this.showToast('วันที่เริ่มขายต้องมาก่อนหรือวันเดียวกับวันที่สิ้นสุด', 'error');
                    return;
                }
                const checkboxes = document.querySelectorAll('#user-product-assignment input:checked');
                assignedProductIds = Array.from(checkboxes).map(cb => parseInt(cb.value, 10));

                commissionRate = parseFloat(document.getElementById('user-commission-rate').value) || 0;
                commissionOnCash = document.getElementById('user-commission-cash').checked;
                commissionOnTransfer = document.getElementById('user-commission-transfer').checked;
                commissionOnCredit = document.getElementById('user-commission-credit').checked;

                // START: NEW - Get value for visible sales days
                const visibleDaysInput = document.getElementById('user-visible-days').value;
                if (visibleDaysInput) {
                    const parsedDays = parseInt(visibleDaysInput, 10);
                    if (!isNaN(parsedDays) && parsedDays >= 0) {
                        visibleSalesDays = parsedDays;
                    }
                }
                // END: NEW
            }

            if (id) {
                const user = this.data.users.find(u => u.id == id);
                if (user.username !== username) {
                    this.data.sales.forEach(sale => {
                        if (sale.sellerId == id) {
                            sale.sellerName = username;
                        }
                    });
                }
                user.username = username;
                if (password) user.password = password;
                user.role = role;

                if (role === 'seller') {
                    user.assignedProductIds = assignedProductIds;
                    user.salesStartDate = startDate;
                    user.salesEndDate = endDate;
                    user.storeId = storeId;
                    user.commissionRate = commissionRate;
                    user.commissionOnCash = commissionOnCash;
                    user.commissionOnTransfer = commissionOnTransfer;
                    user.commissionOnCredit = commissionOnCredit;
                    user.visibleSalesDays = visibleSalesDays; // NEW: Save value
                } else {
                    delete user.assignedProductIds;
                    delete user.salesStartDate;
                    delete user.salesEndDate;
                    delete user.storeId;
                    delete user.commissionRate;
                    delete user.commissionOnCash;
                    delete user.commissionOnTransfer;
                    delete user.commissionOnCredit;
                    delete user.visibleSalesDays; // NEW: Clean up value
                }
                this.showToast('แก้ไขข้อมูลผู้ใช้สำเร็จ');
            } else {
                if (this.data.users.some(u => u.username === username)) {
                    this.showToast('ชื่อผู้ใช้นี้มีอยู่แล้ว', 'error');
                    return;
                }
                if (!password) {
                    this.showToast('กรุณากำหนดรหัสผ่านสำหรับผู้ใช้ใหม่', 'error');
                    return;
                }
                const newUser = { id: Date.now(), username, password, role };
                if (role === 'seller') {
                    newUser.assignedProductIds = assignedProductIds;
                    newUser.salesStartDate = startDate;
                    newUser.salesEndDate = endDate;
                    newUser.storeId = storeId;
                    newUser.commissionRate = commissionRate;
                    newUser.commissionOnCash = commissionOnCash;
                    newUser.commissionOnTransfer = commissionOnTransfer;
                    newUser.commissionOnCredit = commissionOnCredit;
                    newUser.visibleSalesDays = visibleSalesDays; // NEW: Save value
                }
                this.data.users.push(newUser);
                this.showToast('เพิ่มผู้ใช้ใหม่สำเร็จ');
            }

            this.saveData();
            this.renderUserTable();
        },
        
        editUser(id) { 
            const user = this.data.users.find(p => p.id == id);
            if(user) {
                this.setupUserForm(user);
            }
        },
        
        deleteUser(id) { const user = this.data.users.find(u => u.id == id); if (user && user.username === 'admin') { this.showToast('ไม่สามารถลบผู้ใช้ admin ได้', 'error'); return; } if(confirm(`คุณแน่ใจหรือไม่ว่าต้องการลบผู้ใช้ ${user.username}?`)) { this.data.users = this.data.users.filter(u => u.id != id); this.saveData(); this.renderUserTable(); } },
        
        setupUserForm(user = null) {
            const form = document.getElementById('user-form');
            form.reset();

            const productContainer = document.getElementById('user-product-assignment-container');
            const salesContainer = document.getElementById('user-sales-period-container');
            const storeContainer = document.getElementById('user-store-assignment-container');
            const commissionContainer = document.getElementById('user-commission-settings-container');
            const historyContainer = document.getElementById('user-history-view-container'); // NEW

            if (user) { // Editing an existing user
                document.getElementById('user-id').value = user.id;
                document.getElementById('user-username').value = user.username;
                document.getElementById('user-role').value = user.role;
                document.getElementById('user-password').value = '';
                document.getElementById('user-password').placeholder = 'เว้นว่างไว้ถ้าไม่ต้องการเปลี่ยน';

                if (user.role === 'seller') {
                    storeContainer.style.display = 'block';
                    salesContainer.style.display = 'block';
                    commissionContainer.style.display = 'block';
                    historyContainer.style.display = 'block'; // NEW
                    productContainer.style.display = 'grid';
                    
                    document.getElementById('user-commission-rate').value = user.commissionRate || 0;
                    document.getElementById('user-commission-cash').checked = user.commissionOnCash || false;
                    document.getElementById('user-commission-transfer').checked = user.commissionOnTransfer || false;
                    document.getElementById('user-commission-credit').checked = user.commissionOnCredit || false;

                    // START: NEW - Populate visible days input
                    document.getElementById('user-visible-days').value = user.visibleSalesDays ?? '';
                    // END: NEW
                    
                    this.renderUserStoreAssignment(user.storeId);
                    this.renderUserProductAssignment(user.assignedProductIds || []);
                    document.getElementById('user-sales-start-date').value = user.salesStartDate || '';
                    document.getElementById('user-sales-end-date').value = user.salesEndDate || '';
                } else {
                    storeContainer.style.display = 'none';
                    salesContainer.style.display = 'none';
                    commissionContainer.style.display = 'none';
                    historyContainer.style.display = 'none'; // NEW
                    productContainer.style.display = 'none';
                }
            } else { // Setting up for a new user
                document.getElementById('user-id').value = '';
                document.getElementById('user-password').placeholder = 'กำหนดรหัสผ่านสำหรับผู้ใช้ใหม่';
                
                storeContainer.style.display = 'block';
                salesContainer.style.display = 'block';
                commissionContainer.style.display = 'block';
                historyContainer.style.display = 'block'; // NEW
                productContainer.style.display = 'grid';
                
                document.getElementById('user-commission-rate').value = '';
                document.getElementById('user-commission-cash').checked = false;
                document.getElementById('user-commission-transfer').checked = false;
                document.getElementById('user-commission-credit').checked = false;
                document.getElementById('user-visible-days').value = ''; // NEW: Clear input
                this.renderUserStoreAssignment(); 
                this.renderUserProductAssignment(); 
            }
            document.getElementById('user-username').focus();
        },
        
        renderUserProductAssignment(selectedIds = []) { const container = document.getElementById('user-product-assignment'); if (!container) return; container.innerHTML = ''; if (this.data.products.length === 0) { container.innerHTML = '<p>ยังไม่มีสินค้าในระบบ โปรดเพิ่มสินค้าก่อน</p>'; return; } this.data.products.forEach(p => { const isChecked = selectedIds.includes(p.id); container.innerHTML += `<label class="product-item" style="display: block; margin-bottom: 5px;"><input type="checkbox" value="${p.id}" ${isChecked ? 'checked' : ''}> ${p.name}</label>`; }); },
        
        renderUserStoreAssignment(selectedStoreId = null) {
            const container = document.getElementById('user-store-assignment-container');
            if (!container) return; 
            container.innerHTML = ''; 
            if (this.data.stores.length === 0) { 
                container.innerHTML = '<p style="text-align: center; color: red;">ยังไม่มีร้านค้าในระบบ! กรุณาไปที่หน้า "จัดการร้านค้า" เพื่อเพิ่มร้านค้าก่อน</p>'; 
                return; 
            } 
            let selectHTML = '<label for="user-store-select">เลือกร้านค้า:</label><select id="user-store-select"><option value="">-- กรุณาเลือกร้านค้า --</option>'; 
            this.data.stores.forEach(s => { 
                const isSelected = s.id == selectedStoreId; 
                selectHTML += `<option value="${s.id}" ${isSelected ? 'selected' : ''}>${s.name}</option>`; 
            }); 
            selectHTML += '</select>'; 
            container.innerHTML = selectHTML; 
        },

        fillPages(){ 
            document.getElementById('page-pos').innerHTML = `<h2>ขายสินค้า (Point of Sale)</h2><div class="pos-layout"><div><form id="add-to-cart-form" style="max-width:none;"><label for="pos-date">วันที่ขาย:</label><input type="date" id="pos-date"><label for="pos-time">เวลา:</label><input type="time" id="pos-time"><label for="pos-product">เลือกสินค้า:</label><select id="pos-product" required></select><label for="pos-quantity">จำนวน:</label><input type="number" id="pos-quantity" value="1" min="1" required><div id="special-price-container" style="display: none; grid-column: 1 / -1; grid-template-columns: 150px 1fr; align-items: center; gap: 15px;"><label for="special-price">ราคาขายใหม่:</label><div><input type="number" id="special-price" placeholder="กรอกราคาต่อหน่วย" min="0" step="any"><span id="current-price-info" style="font-size: 0.9em; color: #555; margin-left: 10px;"></span></div></div><div class="form-actions"><button type="submit" class="success">เพิ่มลงตะกร้า</button><button type="button" id="toggle-special-price-btn">ใช้ราคาพิเศษ</button></div></form><h3>รายการในตะกร้า</h3><div class="table-container"><table id="cart-table"><thead><tr><th>สินค้า</th><th>ราคาฯ</th><th>จำนวน</th><th>รวม</th><th>ลบ</th></tr></thead><tbody></tbody></table></div></div><div id="cart-summary"><div id="payment-method-container"><h4>ประเภทการชำระเงิน</h4><div class="payment-options-wrapper"><label><input type="radio" name="payment-method" value="เงินสด" checked> เงินสด</label><label><input type="radio" name="payment-method" value="เงินโอน"> เงินโอน</label><label><input type="radio" name="payment-method" value="เครดิต"> เครดิต</label></div><div id="transfer-fields-container"><div style="margin-top:10px;"><label for="transfer-name" style="text-align:left;font-weight:bold;">ชื่อผู้โอน:</label><input type="text" id="transfer-name"></div></div><div id="credit-fields-container"><div style="margin-top:10px;"><label for="credit-buyer-name" style="text-align:left;font-weight:bold;">ชื่อผู้ซื้อ (เครดิต):</label><input type="text" id="credit-buyer-name"></div><div style="margin-top:10px;"><label for="credit-due-days" style="text-align:left;font-weight:bold;">จำนวนวันเครดิต :</label><input type="number" id="credit-due-days" min="0" placeholder="เช่น 7, 15, 30"></div></div></div><div class="cart-action-row"><span class="cart-total-label">สรุปยอด:</span><div id="cart-total">฿0.00</div><button id="process-sale-btn">ยืนยันการขาย</button></div></div></div>`; 
            document.getElementById('page-products').innerHTML = `<h2>จัดการสินค้า</h2> <p style="text-align:center; margin-top:-15px; margin-bottom:20px;">ในหน้านี้ใช้สำหรับสร้างและแก้ไขรายละเอียดสินค้า (ชื่อ, ราคา, หน่วย) เท่านั้น <br>การเพิ่มสต็อกสินค้าต้องทำผ่านหน้า "นำเข้าสินค้า" เท่านั้น</p><form id="product-form"> <input type="hidden" id="product-id"> <label for="product-name">ชื่อสินค้า:</label> <input type="text" id="product-name" required> <label for="product-cost">ราคาทุน:</label> <input type="number" id="product-cost" min="0" step="0.01" required> <label for="product-price">ราคาขาย:</label> <input type="number" id="product-price" min="0" step="0.01" required> <label for="product-unit">หน่วย:</label> <input type="text" id="product-unit" placeholder="เช่น ชิ้น, กล่อง" required> <div class="form-actions"> <button type="submit" class="success">บันทึกสินค้า</button> <button type="button" id="clear-product-form-btn" style="background-color:#6c757d;">เคลียร์ฟอร์ม</button> </div> </form> <div class="table-container"><table id="product-table"> <thead> <tr><th>ชื่อสินค้า</th><th>ราคาทุน</th><th>ราคาขาย</th><th>สต็อก</th><th>หน่วย</th><th>จัดการ</th></tr> </thead> <tbody></tbody> </table></div>`; 
            document.getElementById('page-stock-in').innerHTML = `<h2>บันทึกการนำเข้าสินค้า</h2> <form id="stock-in-form"> <label for="stock-in-product">เลือกสินค้า:</label> <select id="stock-in-product" required></select> <label for="stock-in-quantity">จำนวน:</label> <input type="number" id="stock-in-quantity" min="1" required> <label for="stock-in-cost">ราคาทุนต่อหน่วย:</label> <input type="number" id="stock-in-cost" min="0" step="0.01" required> <div class="form-actions"> <button type="submit" class="success">บันทึกการนำเข้า</button> </div> </form> <h3>ประวัติการนำเข้าล่าสุด</h3> <div class="table-container"><table id="stock-in-history-table"> <thead> <tr><th>วันที่</th><th>เวลา</th><th>สินค้า</th><th>จำนวน</th><th>ทุนต่อหน่วย</th><th>ยอดรวม</th></tr> </thead> <tbody></tbody> </table></div>`; 
            document.getElementById('page-stock-out').innerHTML = `<h2>ปรับสต็อก (นำออก)</h2> <form id="stock-out-form"> <label for="stock-out-product">เลือกสินค้า:</label> <select id="stock-out-product" required></select> <label for="stock-out-quantity">จำนวนที่นำออก:</label> <input type="number" id="stock-out-quantity" min="1" required> <label for="stock-out-reason">เหตุผล:</label> <input type="text" id="stock-out-reason" placeholder="เช่น หมดอายุ, ชำรุด, นับสต็อก" required> <div class="form-actions"> <button type="submit" class="danger">ยืนยันการนำออก</button> </div> </form> <h3>ประวัติการนำออกล่าสุด</h3> <div class="table-container"><table id="stock-out-history-table"> <thead> <tr><th>วันที่</th><th>เวลา</th><th>สินค้า</th><th>จำนวน</th><th>เหตุผล</th></tr> </thead> <tbody></tbody> </table></div>`;
            document.getElementById('page-sales-history').innerHTML = `
                <h2>รายการขายย้อนหลัง</h2>
                <div id="sales-history-export-form">
                    <label>ตั้งแต่วันที่: <input type="date" id="export-sales-start-date"></label>
                    <label>ถึงวันที่: <input type="date" id="export-sales-end-date"></label>
                    <button type="button" id="export-sales-history-csv-btn">ส่งออกเป็น CSV</button>
                </div>
                <div class="table-container">
                    <table id="sales-history-table">
                        <thead>
                            <tr>
                                <th>วันที่</th><th>เวลา</th><th>รายการสินค้า</th><th>ยอดขายรวม</th><th>กำไรรวม</th><th>ประเภทชำระ</th><th>คนขาย</th><th>ร้านค้า</th><th>จัดการ</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>`;
            document.getElementById('page-reports').innerHTML = `<h2>รายงานกำไร/ขาดทุน</h2> <form id="report-filter-form"> <label>ตั้งแต่วันที่:<input type="date" id="report-start-date"></label> <label>ถึงวันที่:<input type="date" id="report-end-date"></label> <label>คนขาย:<select id="report-seller"><option value="all">ทั้งหมด</option></select></label> <button type="submit" id="report-generate-btn">สร้างรายงาน</button> </form> <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; text-align: center;"> <div style="background: #f9f9f9; border: 1px solid var(--border-color); padding: 15px; border-radius: 5px;"> <h3>ยอดขายรวม</h3><p id="report-total-sales" style="font-size: 1.5em; font-weight: bold;">฿0.00</p> </div> <div style="background: #f9f9f9; border: 1px solid var(--border-color); padding: 15px; border-radius: 5px;"> <h3>ต้นทุนรวม</h3><p id="report-total-cost" style="font-size: 1.5em; font-weight: bold;">฿0.00</p> </div> <div style="background: #f9f9f9; border: 1px solid var(--border-color); padding: 15px; border-radius: 5px;"> <h3>กำไรสุทธิ</h3><p id="report-net-profit" style="font-size: 1.5em; font-weight: bold; color: var(--success-color);">฿0.00</p> </div> </div>`; 
            document.getElementById('page-summary').innerHTML = `<h2>สรุปข้อมูลการขายแบบละเอียด</h2><div class="summary-section"> <h3>สรุปด่วน</h3> <div class="summary-form-inline"> <button type="button" id="summary-today-btn" style="background-color: var(--warning-color);">สรุปวันนี้</button> <button type="button" id="summary-all-btn" style="background-color: #673ab7;">สรุปทั้งหมด</button> </div> </div> <div class="summary-section"> <h3>สรุปวันที่เลือก</h3> <div class="summary-form-inline"> <label>เลือกวันที่: <input type="date" id="summary-single-date"></label> <button type="button" id="summary-by-day-btn" style="background-color: #03a9f4;">สรุปวันที่เลือก</button> </div> </div> <div class="summary-section"> <h3>สรุปวันที่ถึงวันที่</h3> <div class="summary-form-inline"> <label>จากวันที่: <input type="date" id="summary-range-start"></label> <label>ถึงวันที่: <input type="date" id="summary-range-end"></label> <button type="button" id="summary-range-btn" style="background-color: #009688;">สรุปตามช่วงวัน</button> </div> </div><div class="summary-section"> <h3>สรุปลูกหนี้ทั้งหมด (เครดิต)</h3> <div class="summary-form-inline"> <label>ผู้ขาย: <select id="summary-credit-seller"></select></label> <label>จากวันที่: <input type="date" id="summary-credit-start-date"></label> <label>ถึงวันที่: <input type="date" id="summary-credit-end-date"></label> <button type="button" id="summary-credit-btn" class="danger">สรุปข้อมูลลูกหนี้</button> </div> </div><div class="summary-section"> <h3>สรุปเงินโอนทั้งหมด</h3> <div class="summary-form-inline"> <label>ผู้ขาย: <select id="summary-transfer-seller"></select></label> <label>จากวันที่: <input type="date" id="summary-transfer-start-date"></label> <label>ถึงวันที่: <input type="date" id="summary-transfer-end-date"></label> <button type="button" id="summary-transfer-btn" style="background-color: #007bff;">สรุปข้อมูลเงินโอน</button> </div> </div>`; 
            document.getElementById('page-stores').innerHTML = `<h2>จัดการร้านค้า</h2> <form id="store-form"> <input type="hidden" id="store-id"> <label for="store-name">ชื่อร้านค้า:</label> <input type="text" id="store-name" required> <div class="form-actions"> <button type="submit" class="success">บันทึกร้านค้า</button> <button type="button" id="clear-store-form-btn" style="background-color:#6c757d;">เคลียร์ฟอร์ม</button> </div> </form> <div class="table-container"><table id="store-table"> <thead> <tr><th>ชื่อร้านค้า</th><th>จัดการ</th></tr> </thead> <tbody></tbody> </table></div>`;
            document.getElementById('page-users').innerHTML = `<h2>จัดการผู้ใช้</h2> <form id="user-form"> <input type="hidden" id="user-id"> <label for="user-username">ชื่อผู้ใช้:</label> <input type="text" id="user-username" required> <label for="user-password">รหัสผ่าน:</label> <input type="password" id="user-password" placeholder="เว้นว่างไว้ถ้าไม่ต้องการเปลี่ยน"> <label for="user-role">ประเภท:</label> <select id="user-role" required> <option value="seller">Seller</option> <option value="admin">Admin</option> </select> <div id="user-store-assignment-container" style="display: none; grid-column: 1/-1;"></div> <div id="user-commission-settings-container" style="display: none; grid-column: 1/-1;"> <h4>ตั้งค่าคอมมิชชั่น</h4> <div style="display: grid; grid-template-columns: 150px 1fr; gap: 10px; align-items: center;"> <label for="user-commission-rate">อัตรา (%):</label> <input type="number" id="user-commission-rate" min="0" max="100" step="any" placeholder="เช่น 3, 5.5"> <label>คิดจากยอดขาย:</label> <div id="user-commission-sources"> <label style="display: inline-block; margin-right: 15px; font-weight: normal;"><input type="checkbox" id="user-commission-cash"> เงินสด</label> <label style="display: inline-block; margin-right: 15px; font-weight: normal;"><input type="checkbox" id="user-commission-transfer"> เงินโอน</label> <label style="display: inline-block; font-weight: normal;"><input type="checkbox" id="user-commission-credit"> เครดิต</label> </div> </div> </div> <div id="user-history-view-container" style="display: none; grid-column: 1/-1;"> <h4>ตั้งค่าการแสดงผลประวัติ</h4> <div style="display: grid; grid-template-columns: 150px 1fr; gap: 10px; align-items: center;"> <label for="user-visible-days">จำนวนวันที่ดูประวัติขายได้:</label> <input type="number" id="user-visible-days" min="0" placeholder="0=วันนี้, 1=วันนี้และเมื่อวาน (เว้นว่าง=ทั้งหมด)"> </div> </div> <div id="user-sales-period-container" style="display: none; grid-column: 1/-1;"> <h4>กำหนดระยะเวลาที่สามารถขายได้</h4> <div style="display: grid; grid-template-columns: 150px 1fr; gap: 10px; align-items: center;"> <label for="user-sales-start-date">วันที่เริ่มขาย:</label> <input type="date" id="user-sales-start-date"> <label for="user-sales-end-date">วันที่สิ้นสุด:</label> <input type="date" id="user-sales-end-date"> </div> </div> <div id="user-product-assignment-container" style="display: none; grid-column: 1/-1;"> <h4>กำหนดสินค้าที่สามารถขายได้</h4> <div id="user-product-assignment" style="max-height: 200px; overflow-y: auto; border: 1px solid #BFBFBF; padding: 10px; border-radius: 10px;"></div> </div> <div class="form-actions"> <button type="submit" class="success">บันทึกผู้ใช้</button> <button type="button" id="clear-user-form-btn" style="background-color:#6c757d;">เคลียร์ฟอร์ม</button> </div> </form> <div class="table-container"><table id="user-table"> <thead> <tr><th>ชื่อผู้ใช้</th><th>ประเภท</th><th>ร้านค้า</th><th>สินค้าที่ขายได้</th><th>ระยะเวลาที่ขายได้</th><th>จัดการ</th></tr> </thead> <tbody></tbody> </table></div>`; 
            document.getElementById('page-data').innerHTML = `<h2>จัดการข้อมูล</h2>
            <!-- Admin Sections -->
            <div class="data-management-section admin-only data-restore-section"><h3>โหลดข้อมูลจากไฟล์ (Restore)</h3><p style="color: var(--danger-color);"><b>คำเตือน:</b> การโหลดข้อมูลจากไฟล์จะรวมข้อมูลเข้ากับข้อมูลปัจจุบัน ข้อมูลที่ซ้ำกันจะถูกเขียนทับด้วยข้อมูลจากไฟล์!</p><input type="file" id="data-file-input" style="display: none;" accept=".json,application/json"><button type="button" id="load-from-file-btn" style="background-color: #E97132;">เลือกไฟล์สำรอง (.json)</button></div>
            <div class="data-management-section admin-only"><h3>สำรองข้อมูล (Backup)</h3><p>สำรองข้อมูลทั้งหมด (ผู้ใช้, สินค้า, ประวัติการขาย) ลงในไฟล์ JSON เพื่อเก็บไว้หรือย้ายไปยังเครื่องอื่น</p><button id="save-to-file-btn" class="success">บันทึกข้อมูลทั้งหมดลงไฟล์</button><button id="save-to-browser-btn" style="background-color: #007bff;">บันทึกข้อมูลปัจจุบันลงในเบราว์เซอร์</button></div>
            <div class="data-management-section admin-only" style="border-color: var(--danger-color);"><h3 style="color: var(--danger-color);">รีเซ็ตข้อมูล (*** การกระทำนี้ไม่สามารถย้อนกลับได้ ***)</h3><p>เลือกเพื่อล้างข้อมูลเฉพาะส่วนที่ต้องการ</p><button id="open-reset-modal-btn" class="danger">เปิดหน้าต่างรีเซ็ตข้อมูล</button></div>
            <div class="collapsible-bar admin-only" data-target="admin-stock-report-content" style="background-color: #00B050;"><span>รายงานสต็อกสินค้า</span><span class="arrow">▶</span></div>
            <div id="admin-stock-report-content" class="collapsible-content admin-only">
                <div style="text-align:center; padding: 10px;">
                    <p>รายงานนี้จะเปรียบเทียบสต็อกที่คำนวณได้จากประวัติ (นำเข้า - ขาย - ปรับออก) กับสต็อกที่บันทึกไว้ปัจจุบัน</p>
                    <button id="generate-stock-report-btn" class="success">สร้างรายงานสต็อก</button>
                    <button id="recalculate-stock-btn" class="danger">คำนวณสต็อกใหม่ทั้งหมด</button>
                </div>
                <div id="stock-summary-report-container" style="margin-top: 15px;"></div>
            </div>

            <!-- Seller Sections: Rebuilt for better filtering -->
            <div class="collapsible-bar seller-only" data-target="seller-backup-content"><span>บันทึกข้อมูล (Backup)</span><span class="arrow">▶</span></div>
            <div id="seller-backup-content" class="collapsible-content seller-only"><div style="text-align:center; padding-top: 10px;"><p style="margin-top:0;">สำรองข้อมูลทั้งหมด (ผู้ใช้, สินค้า, ประวัติการขาย) ลงในไฟล์ JSON เพื่อเก็บไว้หรือย้ายไปยังเครื่องอื่น</p><button id="save-to-file-btn-seller" class="success">บันทึกข้อมูลทั้งหมดลงไฟล์</button><button id="save-to-browser-btn-seller" style="background-color: #007bff;">บันทึกข้อมูลปัจจุบันลงในเบราว์เซอร์</button></div></div>
            
            <div class="collapsible-bar seller-only" data-target="seller-summary-content"><span>รายงานสรุป (สำหรับผู้ใช้ปัจจุบัน)</span><span class="arrow">▶</span></div>
            <div id="seller-summary-content" class="collapsible-content seller-only"><div style="text-align:center;"><div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;"><button id="my-summary-today-btn" style="background-color: var(--warning-color);">สรุปยอดขายวันนี้</button><button id="my-summary-all-btn" style="background-color: #673ab7;">สรุปทั้งหมดของฉัน</button><button id="my-summary-all-credit-btn" class="danger">สรุปลูกหนี้ทั้งหมด</button><button id="my-summary-all-transfer-btn" style="background-color: #007bff;">สรุปเงินโอนทั้งหมด</button></div><div class="summary-form-inline" style="margin-top: 15px; justify-content: center; flex-direction: column; gap:10px; align-items: stretch;"><label>เลือกวันที่: <input type="date" id="my-summary-date" style="width:100%;"></label><button id="my-summary-by-day-btn" style="background-color: #03a9f4;">สรุปยอดขายวันที่เลือก</button></div></div></div>
            
            <div class="collapsible-bar seller-only active" data-target="seller-sales-history-container"><span>ค้นหารายการขาย</span><span class="arrow" style="transform: rotate(90deg);">▶</span></div>
            <div id="seller-sales-history-container" class="collapsible-content seller-only active">
                <form id="seller-sales-filter-form" style="max-width: none; background-color: #eef5ff; padding: 15px; border-radius: 8px;">
                    <div style="grid-column: 1/-1; display:flex; flex-wrap:wrap; gap: 20px; justify-content:center; align-items:center; margin-bottom: 10px;">
                        <label><input type="radio" name="seller-filter-type" value="today" checked> วันนี้</label>
                        <label><input type="radio" name="seller-filter-type" value="by_date"> เลือกวัน</label>
                        <label><input type="radio" name="seller-filter-type" value="by_range"> เลือกช่วง</label>
                    </div>
                    <div id="seller-date-inputs" style="grid-column: 1/-1; display:flex; flex-wrap:wrap; gap: 15px; justify-content:center; align-items:flex-end;">
                        <div id="seller-filter-by-date-div" style="display:none;"><label>เลือกวันที่:<input type="date" id="seller-filter-date"></label></div>
                        <div id="seller-filter-by-range-div" style="display:none; display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
                           <label>จาก:<input type="date" id="seller-filter-start-date"></label>
                           <label>ถึง:<input type="date" id="seller-filter-end-date"></label>
                        </div>
                    </div>
                    <div class="form-actions" style="margin-top: 15px;">
                        <button type="submit" style="background-color:#008CBA;">แสดงรายการ</button>
                    </div>
                </form>
                <div class="table-container" style="margin-top:20px;"><table id="seller-sales-history-table"><thead><tr><th>วันที่</th><th>เวลา</th><th>รายการสินค้า</th><th>ยอดขาย</th><th>ประเภทชำระ</th><th>จัดการ</th></tr></thead><tbody></tbody></table></div>
            </div>`;
        },
        
        attachEventListeners(){ 
            document.getElementById('login-form').addEventListener('submit', (e) => { e.preventDefault(); this.login(document.getElementById('username').value, document.getElementById('password').value); }); 
            document.getElementById('logout-btn').addEventListener('click', () => this.logout()); 
            
            const mainApp = document.getElementById('main-app');
            mainApp.addEventListener('submit', (e) => { 
                if (e.target.id === 'add-to-cart-form') { e.preventDefault(); this.addToCart(e); }
                if (e.target.id === 'product-form') { e.preventDefault(); this.saveProduct(e); } 
                if (e.target.id === 'store-form') { e.preventDefault(); this.saveStore(e); } 
                if (e.target.id === 'stock-in-form') { e.preventDefault(); this.saveStockIn(e); }
                if (e.target.id === 'stock-out-form') { e.preventDefault(); this.saveStockOut(e); }
                if (e.target.id === 'report-filter-form') { e.preventDefault(); this.renderReport(e); } 
                if (e.target.id === 'user-form') { e.preventDefault(); this.saveUser(e); }
                if (e.target.id === 'seller-sales-filter-form') { 
                    e.preventDefault(); 
                    this.renderSellerSalesHistoryWithFilter(); 
                }
            }); 
            mainApp.addEventListener('click', (e) => { 
                if (e.target.id === 'process-sale-btn') this.processSale(); 
                if (e.target.classList.contains('remove-from-cart-btn')) this.removeFromCart(e.target.dataset.index); 
                if (e.target.id === 'toggle-special-price-btn') this.toggleSpecialPrice(); 
                if (e.target.classList.contains('edit-sale-btn')) this.editSale(e.target.dataset.id); 
                if (e.target.classList.contains('delete-sale-btn')) { this.deleteSale(e.target.dataset.id); this.renderSalesHistory(); } 
                if (e.target.classList.contains('seller-delete-sale-btn')) {
                    const saleId = e.target.dataset.id;
                    if (confirm('คุณแน่ใจหรือไม่ว่าต้องการลบรายการขายนี้? สต็อกสินค้าจะถูกคืนเข้าระบบ')) {
                        this.deleteSale(saleId);
                        this.renderSellerSalesHistoryWithFilter();
                    }
                }
                if (e.target.id === 'clear-product-form-btn') { document.getElementById('product-form').reset(); document.getElementById('product-id').value = ''; } 
                if (e.target.classList.contains('edit-product-btn')) this.editProduct(e.target.dataset.id); 
                if (e.target.classList.contains('delete-product-btn')) this.deleteProduct(e.target.dataset.id);
                if (e.target.id === 'clear-store-form-btn') { document.getElementById('store-form').reset(); document.getElementById('store-id').value = ''; }
                if (e.target.classList.contains('edit-store-btn')) this.editStore(e.target.dataset.id);
                if (e.target.classList.contains('delete-store-btn')) this.deleteStore(e.target.dataset.id);
                if (e.target.id === 'clear-user-form-btn') this.setupUserForm();
                if (e.target.classList.contains('edit-user-btn')) this.editUser(e.target.dataset.id); 
                if (e.target.classList.contains('delete-user-btn')) this.deleteUser(e.target.dataset.id); 
                
                if (e.target.id === 'export-sales-history-csv-btn') {
                    this.exportSalesHistoryToCsv();
                }

                const collapsibleBar = e.target.closest('.collapsible-bar');
                if (collapsibleBar) {
                    const targetId = collapsibleBar.dataset.target;
                    const content = document.getElementById(targetId);
                    if (content) {
                        collapsibleBar.classList.toggle('active');
                        content.classList.toggle('active');
                    }
                }
                
                if (e.target.id === 'load-from-file-btn') document.getElementById('data-file-input').click(); 
                if (e.target.id === 'save-to-file-btn' || e.target.id === 'save-to-file-btn-seller') this.saveBackupToFile(); 
                if (e.target.id === 'save-to-browser-btn' || e.target.id === 'save-to-browser-btn-seller') this.manualSaveToBrowser(); 
                
                if (e.target.id === 'open-reset-modal-btn') this.openResetModal();

                if (e.target.id === 'generate-stock-report-btn') this.renderStockSummaryReport();
                if (e.target.id === 'recalculate-stock-btn') this.handleRecalculateStock();

                 // Summary buttons
                if (e.target.id === 'summary-today-btn') this.summarizeToday(); 
                if (e.target.id === 'summary-all-btn') this.summarizeAll(); 
                if (e.target.id === 'summary-by-day-btn') this.summarizeByDay(); 
                if (e.target.id === 'summary-range-btn') this.summarizeByRange();
                if (e.target.id === 'summary-credit-btn') this.summarizeAllCreditByAdmin(); 
                if (e.target.id === 'summary-transfer-btn') this.summarizeAllTransfersByAdmin();
                if (e.target.id === 'my-summary-today-btn') this.summarizeMyToday(); 
                if (e.target.id === 'my-summary-all-btn') this.summarizeMyAll(); 
                if (e.target.id === 'my-summary-by-day-btn') this.summarizeMyDay(); 
                if (e.target.id === 'my-summary-all-credit-btn') this.summarizeMyAllCredit(); 
                if (e.target.id === 'my-summary-all-transfer-btn') this.summarizeMyAllTransfers();
            }); 
		
	        mainApp.addEventListener('change', (e) => { 
                if(e.target.name === 'payment-method') this.togglePaymentDetailFields(); 
                if (e.target.id === 'user-role') { 
                    const productDiv = document.getElementById('user-product-assignment-container'); 
                    const salesDiv = document.getElementById('user-sales-period-container'); 
                    const storeDiv = document.getElementById('user-store-assignment-container');
                    const commissionDiv = document.getElementById('user-commission-settings-container');
                    const historyDiv = document.getElementById('user-history-view-container'); // NEW
                    if(productDiv && salesDiv && storeDiv && commissionDiv && historyDiv) { // NEW: Add historyDiv check
                        if (e.target.value === 'seller') { 
                            storeDiv.style.display = 'block'; 
                            salesDiv.style.display = 'block'; 
                            commissionDiv.style.display = 'block';
                            historyDiv.style.display = 'block'; // NEW
                            productDiv.style.display = 'grid'; 
                            this.renderUserStoreAssignment();
                            this.renderUserProductAssignment(); 
                        } else { 
                            storeDiv.style.display = 'none';
                            salesDiv.style.display = 'none'; 
                            commissionDiv.style.display = 'none';
                            historyDiv.style.display = 'none'; // NEW
                            productDiv.style.display = 'none'; 
                        } 
                    } 
                } 
                if (e.target.id === 'data-file-input') this.promptLoadFromFile(e); 
                if (e.target.id === 'pos-product') this.updateSpecialPriceInfo(); 
                
                if (['report-start-date', 'report-end-date', 'report-seller'].includes(e.target.id)) {
                    this.renderReport(e);
                }

                if (e.target.id === 'reset-products-checkbox') {
                    if (e.target.checked) {
                        document.getElementById('reset-sales-checkbox').checked = true;
                        document.getElementById('reset-stockins-checkbox').checked = true;
                    }
                }
                
                if (e.target.id === 'pos-date' || e.target.id === 'pos-time') {
                    const dateInput = document.getElementById('pos-date');
                    const timeInput = document.getElementById('pos-time');
                    if(dateInput.value || timeInput.value) {
                        dateInput.classList.add('backdating-active');
                        timeInput.classList.add('backdating-active');
                    } else {
                        dateInput.classList.remove('backdating-active');
                        timeInput.classList.remove('backdating-active');
                    }
                }

                if (e.target.name === 'seller-filter-type') {
                    const byDateDiv = document.getElementById('seller-filter-by-date-div');
                    const byRangeDiv = document.getElementById('seller-filter-by-range-div');
                    switch (e.target.value) {
                        case 'today':
                            byDateDiv.style.display = 'none';
                            byRangeDiv.style.display = 'none';
                            break;
                        case 'by_date':
                            byDateDiv.style.display = 'block';
                            byRangeDiv.style.display = 'none';
                            break;
                        case 'by_range':
                            byDateDiv.style.display = 'none';
                            byRangeDiv.style.display = 'flex';
                            break;
                    }
                }
            }); 
            
            document.getElementById('cancel-reset-btn').addEventListener('click', () => this.closeResetModal());
            document.getElementById('confirm-selective-reset-btn').addEventListener('click', () => this.handleSelectiveReset());
        },
    };
    
   window.App = App;
    App.init();
});
</script>
</body>
</html>
